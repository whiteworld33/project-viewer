<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ë·°ì–´</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 16px; background: #fff; color: #333; }

        /* í‘œ ìŠ¤íƒ€ì¼ */
        .table-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { padding: 8px 10px; background: #4a5568; color: #fff; text-align: right; white-space: nowrap; font-weight: 500; }
        th:first-child { text-align: center; }
        td { padding: 6px 10px; border-bottom: 1px solid #e8e8e8; text-align: right; white-space: nowrap; }
        td:first-child { text-align: center; font-weight: 500; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #edf2f7; }
        tr.is-forecast { color: #a0aec0; }
        tr.is-current { background: #ebf8ff; font-weight: 600; }

        /* ì—ëŸ¬ */
        .error { text-align: center; padding: 40px; color: #e53e3e; }
        .error h2 { margin-bottom: 8px; }

        /* ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ */
        #chart { width: 100%; }
    </style>
</head>
<body>

<div id="content">
    <div class="error">
        <h2>ë¡œë”© ì¤‘...</h2>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // â”€â”€ URL íŒŒë¼ë¯¸í„° ì½ê¸° â”€â”€
    var params = new URLSearchParams(window.location.search);
    var projectName = params.get('project');
    var viewType = params.get('type') || 'table'; // table | chart

    var contentDiv = document.getElementById('content');

    if (!projectName) {
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ project íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>ì˜ˆ: view.html?project=EL&type=table</p></div>';
        return;
    }

    // â”€â”€ localStorageì—ì„œ ë°ì´í„° ì½ê¸° â”€â”€
    var raw = localStorage.getItem('projectViewerData');
    if (!raw) {
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>admin.htmlì—ì„œ ë¨¼ì € ë°ì´í„°ë¥¼ ì €ì¥í•´ ì£¼ì„¸ìš”.</p></div>';
        return;
    }

    var allData;
    try { allData = JSON.parse(raw); } catch(e) {
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜</h2></div>';
        return;
    }

    var project = allData[projectName];
    if (!project) {
        var available = Object.keys(allData).join(', ');
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ "' + projectName + '" í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2><p>ì €ì¥ëœ í”„ë¡œì íŠ¸: ' + available + '</p></div>';
        return;
    }

    var rows = project.rows;
    var currentDate = project.current;
    var kickoff = project.kickoff;
    var launch = project.launch;

    // â”€â”€â”€â”€â”€â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€
    if (viewType === 'table') {
        var html = '<div class="table-title">ğŸ“Š ' + projectName + ' â€” MM &amp; ëˆ„ì ê°œë°œë¹„ (' + kickoff + ' ~ ' + launch + ')</div>';
        html += '<table><thead><tr>'
            + '<th>ë‚ ì§œ</th><th>MM (ê°œë°œ)</th><th>MM (ì‚¬ì—…)</th><th>MM (í•©ê³„)</th>'
            + '<th>ëˆ„ì ê°œë°œë¹„-ê°œë°œ (ë°±ë§Œ)</th><th>ëˆ„ì ê°œë°œë¹„-ì‚¬ì—… (ë°±ë§Œ)</th><th>ëˆ„ì ê°œë°œë¹„-í•©ê³„ (ë°±ë§Œ)</th><th>GIê°œë°œë¹„ (ë°±ë§Œ)</th>'
            + '</tr></thead><tbody>';

        rows.forEach(function(r) {
            var isForecast = r.date > currentDate;
            var isCurrent = r.date === currentDate;
            var cls = isCurrent ? ' class="is-current"' : (isForecast ? ' class="is-forecast"' : '');
            html += '<tr' + cls + '>'
                + '<td>' + r.date + '</td>'
                + '<td>' + r.mmDev.toFixed(1) + '</td>'
                + '<td>' + r.mmBiz.toFixed(1) + '</td>'
                + '<td>' + r.mmTotal.toFixed(1) + '</td>'
                + '<td>' + Math.round(r.costDev / 1000000).toLocaleString() + '</td>'
                + '<td>' + Math.round(r.costBiz / 1000000).toLocaleString() + '</td>'
                + '<td>' + Math.round(r.costTotal / 1000000).toLocaleString() + '</td>'
                + '<td>' + Math.round(r.costGI / 1000000).toLocaleString() + '</td>'
                + '</tr>';
        });
        html += '</tbody></table>';
        contentDiv.innerHTML = html;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€
    else if (viewType === 'chart') {
        contentDiv.innerHTML = '<div id="chart"></div>';

        var labels = rows.map(function(r) { return r.date; });
        var devData = rows.map(function(r) { return r.mmDev; });
        var bizData = rows.map(function(r) { return r.mmBiz; });

        var traceDev = {
            x: labels, y: devData,
            name: 'ê°œë°œ MM', type: 'scatter', mode: 'lines',
            stackgroup: 'one',
            line: { color: 'rgb(55, 128, 191)' },
            fillcolor: 'rgba(55, 128, 191, 0.6)'
        };
        var traceBiz = {
            x: labels, y: bizData,
            name: 'ì‚¬ì—… MM', type: 'scatter', mode: 'lines',
            stackgroup: 'one',
            line: { color: 'rgb(219, 64, 82)' },
            fillcolor: 'rgba(219, 64, 82, 0.6)'
        };

        var lastLabel = labels[labels.length - 1] || launch;

        var layout = {
            title: { text: projectName + ' â€” ì›”ë³„ MM í˜„í™©', font: { size: 16 } },
            xaxis: { title: 'ì›”' },
            yaxis: { title: 'MM (Man-Month)' },
            margin: { t: 50, b: 50, l: 60, r: 20 },
            shapes: [
                {
                    type: 'rect',
                    x0: currentDate, x1: lastLabel,
                    y0: 0, y1: 1, yref: 'paper',
                    fillcolor: 'rgba(255, 255, 255, 0.45)',
                    line: { width: 0 },
                    layer: 'above'
                },
                {
                    type: 'line',
                    x0: currentDate, x1: currentDate,
                    y0: 0, y1: 1, yref: 'paper',
                    line: { color: 'rgba(0,0,0,0.5)', width: 2, dash: 'dash' },
                    layer: 'above'
                }
            ],
            annotations: [{
                x: currentDate, y: 1.05, yref: 'paper',
                text: 'â—€ ì‹¤ì  | ì˜ˆì¸¡ â–¶',
                showarrow: false,
                font: { size: 11, color: 'rgba(0,0,0,0.6)' },
                yanchor: 'bottom'
            }]
        };

        Plotly.newPlot('chart', [traceDev, traceBiz], layout, { responsive: true });
    }

    else {
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” type: ' + viewType + '</h2><p>table ë˜ëŠ” chartë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p></div>';
    }
});
</script>
</body>
</html>