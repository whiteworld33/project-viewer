<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ë·°ì–´</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 16px; background: #fff; color: #333; }

        .table-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { padding: 8px 10px; background: #4a5568; color: #fff; text-align: right; white-space: nowrap; font-weight: 500; }
        th:first-child { text-align: center; }
        td { padding: 6px 10px; border-bottom: 1px solid #e8e8e8; text-align: right; white-space: nowrap; }
        td:first-child { text-align: center; font-weight: 500; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #edf2f7; }
        tr.is-forecast { color: #a0aec0; }
        tr.is-current { background: #ebf8ff; font-weight: 600; }

        .error { text-align: center; padding: 40px; color: #e53e3e; }
        .error h2 { margin-bottom: 8px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 12px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        html, body { height: 100%; overflow: hidden; }
        #content { width: 100vw; height: 100vh; }
        #content.table-mode { height: auto; overflow: auto; padding: 16px; }
        #chart { width: 100%; height: 100%; }
    </style>
</head>
<body>

<div id="content">
    <div class="loading">
        <div class="loader"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<script>
(function() {

    var params = new URLSearchParams(window.location.search);
    var projectName = params.get('project');
    var viewType = params.get('type') || 'table';
    var contentDiv = document.getElementById('content');

    if (!projectName) {
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ project íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>ì˜ˆ: view.html?project=EL&type=table</p></div>';
        return;
    }

    // â”€â”€ JSON ë°ì´í„° ê²½ë¡œ: ì ˆëŒ€ URLë¡œ ê³„ì‚° (ë…¸ì…˜ ì„ë² ë“œ í˜¸í™˜) â”€â”€
    var currentPath = window.location.href.split('?')[0];
    var basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
    var jsonUrl = basePath + 'data/projects.json';

    fetch(jsonUrl)
        .then(function(res) {
            if (!res.ok) throw new Error('projects.jsonì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (HTTP ' + res.status + ')');
            return res.json();
        })
        .then(function(allData) {
            var project = allData[projectName];
            if (!project) {
                var available = Object.keys(allData).join(', ');
                contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ "' + projectName + '" í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2><p>ì €ì¥ëœ í”„ë¡œì íŠ¸: ' + available + '</p></div>';
                return;
            }

            var rows = project.rows;
            var currentDate = project.current;
            var kickoff = project.kickoff;
            var launch = project.launch;

            // â”€â”€â”€â”€â”€â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€
            if (viewType === 'table') {
                contentDiv.classList.add('table-mode');
                var html = '<div class="table-title">ğŸ“Š ' + projectName + ' â€” MM &amp; ëˆ„ì ê°œë°œë¹„ (' + kickoff + ' ~ ' + launch + ')</div>';
                html += '<table><thead><tr>'
                    + '<th>ë‚ ì§œ</th><th>MM (ê°œë°œ)</th><th>MM (ì‚¬ì—…)</th><th>MM (í•©ê³„)</th>'
                    + '<th>ëˆ„ì ê°œë°œë¹„-ê°œë°œ (ë°±ë§Œ)</th><th>ëˆ„ì ê°œë°œë¹„-ì‚¬ì—… (ë°±ë§Œ)</th><th>ëˆ„ì ê°œë°œë¹„-í•©ê³„ (ë°±ë§Œ)</th><th>GIê°œë°œë¹„ (ë°±ë§Œ)</th>'
                    + '</tr></thead><tbody>';

                rows.forEach(function(r) {
                    var isForecast = r.date > currentDate;
                    var isCurrent = r.date === currentDate;
                    var cls = isCurrent ? ' class="is-current"' : (isForecast ? ' class="is-forecast"' : '');
                    html += '<tr' + cls + '>'
                        + '<td>' + r.date + '</td>'
                        + '<td>' + r.mmDev.toFixed(1) + '</td>'
                        + '<td>' + r.mmBiz.toFixed(1) + '</td>'
                        + '<td>' + r.mmTotal.toFixed(1) + '</td>'
                        + '<td>' + Math.round(r.costDev / 1000000).toLocaleString() + '</td>'
                        + '<td>' + Math.round(r.costBiz / 1000000).toLocaleString() + '</td>'
                        + '<td>' + Math.round(r.costTotal / 1000000).toLocaleString() + '</td>'
                        + '<td>' + Math.round(r.costGI / 1000000).toLocaleString() + '</td>'
                        + '</tr>';
                });
                html += '</tbody></table>';
                contentDiv.innerHTML = html;
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'chart') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';

                var labels = rows.map(function(r) { return r.date; });
                var devData = rows.map(function(r) { return r.mmDev; });
                var bizData = rows.map(function(r) { return r.mmBiz; });

                var traceDev = {
                    x: labels, y: devData,
                    name: 'ê°œë°œ MM', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(55, 128, 191)' },
                    fillcolor: 'rgba(55, 128, 191, 0.6)',
                    hovertemplate: '%{x}<br>ê°œë°œ MM: %{y:.1f}<extra></extra>'
                };
                var traceBiz = {
                    x: labels, y: bizData,
                    name: 'ì‚¬ì—… MM', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(219, 64, 82)' },
                    fillcolor: 'rgba(219, 64, 82, 0.6)',
                    hovertemplate: '%{x}<br>ì‚¬ì—… MM: %{y:.1f}<extra></extra>'
                };

                var lastLabel = labels[labels.length - 1] || launch;

                var layout = {
                    title: { text: projectName + ' â€” ì›”ë³„ MM í˜„í™©', font: { size: 16 }, y: 0.98 },
                    xaxis: {
                        title: '',
                        tickangle: -45,
                        tickformat: '%Y-%m',
                        tickfont: { size: 10 },
                        nticks: 40,
                        ticklabeloverflow: 'allow'
                    },
                    yaxis: { title: 'MM (Man-Month)' },
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.25, yanchor: 'top' },
                    margin: { t: 60, b: 90, l: 60, r: 20 },
                    shapes: [
                        {
                            type: 'rect',
                            x0: currentDate, x1: lastLabel,
                            y0: 0, y1: 1, yref: 'paper',
                            fillcolor: 'rgba(255, 255, 255, 0.45)',
                            line: { width: 0 },
                            layer: 'above'
                        },
                        {
                            type: 'line',
                            x0: currentDate, x1: currentDate,
                            y0: 0, y1: 1, yref: 'paper',
                            line: { color: 'rgba(0,0,0,0.5)', width: 2, dash: 'dash' },
                            layer: 'above'
                        }
                    ],
                    annotations: [{
                        x: currentDate, y: 1.02, yref: 'paper',
                        text: 'â—€ ì‹¤ì  | ì˜ˆì¸¡ â–¶',
                        showarrow: false,
                        font: { size: 11, color: 'rgba(0,0,0,0.6)' },
                        yanchor: 'bottom'
                    }]
                };

                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, [traceDev, traceBiz], layout, { responsive: true });
                // iframe ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì°¨íŠ¸ í¬ê¸° ìë™ ì¡°ì ˆ
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€ COST CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'cost') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';
                var labels = rows.map(function(r) { return r.date; });
                var devCostData = rows.map(function(r) { return r.costDev / 1000000; });
                var bizCostData = rows.map(function(r) { return r.costBiz / 1000000; });
                var traceDevCost = {
                    x: labels, y: devCostData,
                    name: 'ê°œë°œë¹„', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(55, 128, 191)' },
                    fillcolor: 'rgba(55, 128, 191, 0.6)',
                    hovertemplate: '%{x}<br>ê°œë°œë¹„: %{y:,.0f} ë°±ë§Œì›<extra></extra>'
                };
                var traceBizCost = {
                    x: labels, y: bizCostData,
                    name: 'ì‚¬ì—…ë¹„', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(219, 64, 82)' },
                    fillcolor: 'rgba(219, 64, 82, 0.6)',
                    hovertemplate: '%{x}<br>ì‚¬ì—…ë¹„: %{y:,.0f} ë°±ë§Œì›<extra></extra>'
                };
                var lastLabel = labels[labels.length - 1] || launch;
                var costLayout = {
                    title: { text: projectName + ' â€” ëˆ„ì  ê°œë°œë¹„ í˜„í™©', font: { size: 16 }, y: 0.98 },
                    xaxis: {
                        title: '',
                        tickangle: -45,
                        tickformat: '%Y-%m',
                        tickfont: { size: 10 },
                        nticks: 40,
                        ticklabeloverflow: 'allow'
                    },
                    yaxis: { title: 'ëˆ„ì  ê°œë°œë¹„ (ë°±ë§Œì›)' },
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.25, yanchor: 'top' },
                    margin: { t: 60, b: 90, l: 80, r: 20 },
                    shapes: [
                        {
                            type: 'rect',
                            x0: currentDate, x1: lastLabel,
                            y0: 0, y1: 1, yref: 'paper',
                            fillcolor: 'rgba(255, 255, 255, 0.45)',
                            line: { width: 0 },
                            layer: 'above'
                        },
                        {
                            type: 'line',
                            x0: currentDate, x1: currentDate,
                            y0: 0, y1: 1, yref: 'paper',
                            line: { color: 'rgba(0,0,0,0.5)', width: 2, dash: 'dash' },
                            layer: 'above'
                        }
                    ],
                    annotations: [{
                        x: currentDate, y: 1.02, yref: 'paper',
                        text: 'â—€ ì‹¤ì  | ì˜ˆì¸¡ â–¶',
                        showarrow: false,
                        font: { size: 11, color: 'rgba(0,0,0,0.6)' },
                        yanchor: 'bottom'
                    }]
                };
                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, [traceDevCost, traceBizCost], costLayout, { responsive: true });
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }
            // â”€â”€â”€â”€â”€â”€â”€â”€ BAR CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'bar') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';
                // ê¸°ì¤€ì›” ê¸°ì¤€ ìµœê·¼ 6ê°œì›” í•„í„°ë§ (currentDate í¬í•¨ ì´ì „ 5ê°œì›”)
                function subtractMonths(ym, n) {
                    var p = ym.split('-');
                    var y = parseInt(p[0]), mo = parseInt(p[1]) - 1 - n;
                    while (mo < 0) { mo += 12; y--; }
                    return y + '-' + ('0' + (mo + 1)).slice(-2);
                }
                var fromDate = subtractMonths(currentDate, 5);
                var barRows = rows.filter(function(r) {
                    return r.date >= fromDate && r.date <= currentDate;
                });
                if (barRows.length === 0 || !barRows[0].costBreakdown) {
                    contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ í•­ëª©ë³„ ë¹„ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>admin.htmlì—ì„œ ë¹„ìš© ì‹œíŠ¸ëª…ì„ ì…ë ¥í•˜ê³  ë‹¤ì‹œ JSONì„ ìƒì„±í•´ ì£¼ì„¸ìš”.</p></div>';
                    return;
                }
                var bLabels = barRows.map(function(r) { return r.date; });
                var K = 1000; // ì²œì› ë‹¨ìœ„ ë³€í™˜ (/1000)
                var categories = [
                    { key: 'labor',        name: 'ì¸ê±´ë¹„',     color: 'rgb(55,128,191)'  },
                    { key: 'marketing',    name: 'ë§ˆì¼€íŒ…ë¹„',   color: 'rgb(243,156,18)'  },
                    { key: 'outsourcing',  name: 'ì™¸ì£¼ë¹„',     color: 'rgb(39,174,96)'   },
                    { key: 'depreciation', name: 'ê°ê°€ìƒê°ë¹„', color: 'rgb(142,68,173)'  },
                    { key: 'server',       name: 'ì„œë²„ë¹„',     color: 'rgb(22,160,133)'  },
                    { key: 'other',        name: 'ê¸°íƒ€ ìš´ì˜ë¹„',color: 'rgb(127,140,141)' }
                ];
                var barTraces = categories.map(function(cat) {
                    var yVals = barRows.map(function(r) {
                        var bd = r.costBreakdown || {};
                        return (bd[cat.key] || 0) / K;
                    });
                    return {
                        x: bLabels,
                        y: yVals,
                        text: yVals.map(function(v) { return v > 0 ? v.toLocaleString() : ''; }),
                        textposition: 'inside',
                        insidetextanchor: 'middle',
                        textfont: { size: 9, color: '#fff' },
                        name: cat.name,
                        type: 'bar',
                        marker: { color: cat.color },
                        hovertemplate: '%{x}<br>' + cat.name + ': %{y:,.0f} ì²œì›<extra></extra>'
                    };
                });
                var barLayout = {
                    title: { text: projectName + ' â€” ì›”ë³„ ê°œë°œë¹„ í˜„í™© (ë‹¨ìœ„:ì²œì›)', font: { size: 16 }, y: 0.98 },
                    barmode: 'stack',
                    xaxis: {
                        title: '',
                        tickangle: -30,
                        tickfont: { size: 11 },
                        ticklabeloverflow: 'allow'
                    },
                    yaxis: { title: 'ê°œë°œë¹„ (ì²œì›)' },
                    bargap: 0.5,
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2, yanchor: 'top' },
                    margin: { t: 60, b: 80, l: 80, r: 20 }
                };
                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, barTraces, barLayout, { responsive: true });
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }
            else {
                contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” type: ' + viewType + '</h2><p>table, chart, cost, ë˜ëŠ” barë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p></div>';
            }
        })
        .catch(function(err) {
            contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h2><p>' + err.message + '</p><p style="margin-top:8px; color:#666; font-size:13px;">data/projects.json íŒŒì¼ì´ ë ˆí¬ì— ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</p></div>';
        });
})();
</script>
</body>
</html>
