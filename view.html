<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ë·°ì–´</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 16px; background: #fff; color: #333; }

        .table-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; color: #333; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { padding: 8px 10px; background: #4a5568; color: #fff; text-align: right; white-space: nowrap; font-weight: 500; }
        th:first-child { text-align: center; }
        td { padding: 6px 10px; border-bottom: 1px solid #e8e8e8; text-align: right; white-space: nowrap; }
        td:first-child { text-align: center; font-weight: 500; }
        tr:nth-child(even) { background: #f8f9fa; }
        tr:hover { background: #edf2f7; }
        tr.is-forecast { color: #a0aec0; }
        tr.is-current { background: #ebf8ff; font-weight: 600; }

        .error { text-align: center; padding: 40px; color: #e53e3e; }
        .error h2 { margin-bottom: 8px; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 32px; height: 32px; animation: spin 1s linear infinite; margin: 12px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        html, body { height: 100%; overflow: hidden; }
        #content { width: 100vw; height: 100vh; }
        #content.table-mode { height: auto; overflow: auto; padding: 16px; }
        #chart { width: 100%; height: 100%; }
        /* Dashboard */
        .dash-header { font-size: 17px; font-weight: 700; padding: 14px 16px 10px; color: #333; border-bottom: 2px solid #eee; background: #fafafa; }
        .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 12px; }
        .dash-item { height: 360px; background: #fff; border: 1px solid #e8e8e8; border-radius: 8px; overflow: hidden; }
        .dash-item.full-width { grid-column: 1 / -1; height: 320px; }
        .dash-urls { padding: 14px 16px; border-top: 2px solid #eee; background: #fafafa; }
        .dash-urls h4 { font-size: 14px; font-weight: 600; margin-bottom: 10px; color: #333; }
        .dash-url-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
        .dash-url-row .url-label { font-size: 12px; color: #888; min-width: 60px; flex-shrink: 0; }
        .dash-url-row code { flex: 1; background: #f5f5f5; padding: 5px 9px; border-radius: 4px; font-size: 11px; word-break: break-all; border: 1px solid #e0e0e0; }
        .dash-url-row .copy-btn { font-size: 11px; padding: 4px 10px; background: #17a2b8; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .dash-url-row .copy-btn:hover { background: #138496; }
    </style>
</head>
<body>

<div id="content">
    <div class="loading">
        <div class="loader"></div>
        <p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
</div>

<script>
(function() {

    var params = new URLSearchParams(window.location.search);
    var projectName = params.get('project');
    var viewType = params.get('type') || 'table';
    var contentDiv = document.getElementById('content');

    if (!projectName) {
        contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ project íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>ì˜ˆ: view.html?project=EL&type=table</p></div>';
        return;
    }

    // â”€â”€ JSON ë°ì´í„° ê²½ë¡œ: ì ˆëŒ€ URLë¡œ ê³„ì‚° (ë…¸ì…˜ ì„ë² ë“œ í˜¸í™˜) â”€â”€
    var currentPath = window.location.href.split('?')[0];
    var basePath = currentPath.substring(0, currentPath.lastIndexOf('/') + 1);
    var jsonUrl = basePath + 'data/projects.json';

    fetch(jsonUrl)
        .then(function(res) {
            if (!res.ok) throw new Error('projects.jsonì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (HTTP ' + res.status + ')');
            return res.json();
        })
        .then(function(allData) {
            var project = allData[projectName];
            if (!project) {
                var available = Object.keys(allData).join(', ');
                contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ "' + projectName + '" í”„ë¡œì íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2><p>ì €ì¥ëœ í”„ë¡œì íŠ¸: ' + available + '</p></div>';
                return;
            }

            var rows = project.rows;
            var currentDate = project.current;
            var kickoff = project.kickoff;
            var launch = project.launch;

            // â”€â”€â”€â”€â”€â”€â”€â”€ TABLE â”€â”€â”€â”€â”€â”€â”€â”€
            if (viewType === 'table') {
                contentDiv.classList.add('table-mode');
                var html = '<div class="table-title">ğŸ“Š ' + projectName + ' â€” MM &amp; ëˆ„ì ê°œë°œë¹„ (' + kickoff + ' ~ ' + launch + ')</div>';
                html += '<table><thead><tr>'
                    + '<th>ë‚ ì§œ</th><th>MM (ê°œë°œ)</th><th>MM (ì‚¬ì—…)</th><th>MM (í•©ê³„)</th>'
                    + '<th>ëˆ„ì ê°œë°œë¹„-ê°œë°œ (ë°±ë§Œ)</th><th>ëˆ„ì ê°œë°œë¹„-ì‚¬ì—… (ë°±ë§Œ)</th><th>ëˆ„ì ê°œë°œë¹„-í•©ê³„ (ë°±ë§Œ)</th><th>GIê°œë°œë¹„ (ë°±ë§Œ)</th>'
                    + '</tr></thead><tbody>';

                rows.forEach(function(r) {
                    var isForecast = r.date > currentDate;
                    var isCurrent = r.date === currentDate;
                    var cls = isCurrent ? ' class="is-current"' : (isForecast ? ' class="is-forecast"' : '');
                    html += '<tr' + cls + '>'
                        + '<td>' + r.date + '</td>'
                        + '<td>' + r.mmDev.toFixed(1) + '</td>'
                        + '<td>' + r.mmBiz.toFixed(1) + '</td>'
                        + '<td>' + r.mmTotal.toFixed(1) + '</td>'
                        + '<td>' + Math.round(r.costDev / 1000000).toLocaleString() + '</td>'
                        + '<td>' + Math.round(r.costBiz / 1000000).toLocaleString() + '</td>'
                        + '<td>' + Math.round(r.costTotal / 1000000).toLocaleString() + '</td>'
                        + '<td>' + Math.round(r.costGI / 1000000).toLocaleString() + '</td>'
                        + '</tr>';
                });
                html += '</tbody></table>';
                contentDiv.innerHTML = html;
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'chart') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';

                var labels = rows.map(function(r) { return r.date; });
                var devData = rows.map(function(r) { return r.mmDev; });
                var bizData = rows.map(function(r) { return r.mmBiz; });

                var traceDev = {
                    x: labels, y: devData,
                    name: 'ê°œë°œ MM', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(55, 128, 191)' },
                    fillcolor: 'rgba(55, 128, 191, 0.6)',
                    hovertemplate: '%{x}<br>ê°œë°œ MM: %{y:.1f}<extra></extra>'
                };
                var traceBiz = {
                    x: labels, y: bizData,
                    name: 'ì‚¬ì—… MM', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(219, 64, 82)' },
                    fillcolor: 'rgba(219, 64, 82, 0.6)',
                    hovertemplate: '%{x}<br>ì‚¬ì—… MM: %{y:.1f}<extra></extra>'
                };

                var lastLabel = labels[labels.length - 1] || launch;

                var layout = {
                    title: { text: projectName + ' â€” ì›”ë³„ MM í˜„í™©', font: { size: 16 }, y: 0.98 },
                    xaxis: {
                        title: '',
                        tickangle: -45,
                        tickformat: '%Y-%m',
                        tickfont: { size: 10 },
                        nticks: 40,
                        ticklabeloverflow: 'allow'
                    },
                    yaxis: { title: 'MM (Man-Month)' },
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.25, yanchor: 'top' },
                    margin: { t: 60, b: 90, l: 60, r: 20 },
                    shapes: [
                        {
                            type: 'rect',
                            x0: currentDate, x1: lastLabel,
                            y0: 0, y1: 1, yref: 'paper',
                            fillcolor: 'rgba(255, 255, 255, 0.45)',
                            line: { width: 0 },
                            layer: 'above'
                        },
                        {
                            type: 'line',
                            x0: currentDate, x1: currentDate,
                            y0: 0, y1: 1, yref: 'paper',
                            line: { color: 'rgba(0,0,0,0.5)', width: 2, dash: 'dash' },
                            layer: 'above'
                        }
                    ],
                    annotations: [{
                        x: currentDate, y: 1.02, yref: 'paper',
                        text: 'â—€ ì‹¤ì  | ì˜ˆì¸¡ â–¶',
                        showarrow: false,
                        font: { size: 11, color: 'rgba(0,0,0,0.6)' },
                        yanchor: 'bottom'
                    }]
                };

                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, [traceDev, traceBiz], layout, { responsive: true });
                // iframe ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ì°¨íŠ¸ í¬ê¸° ìë™ ì¡°ì ˆ
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }

            // â”€â”€â”€â”€â”€â”€â”€â”€ COST CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'cost') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';
                var labels = rows.map(function(r) { return r.date; });
                var devCostData = rows.map(function(r) { return r.costDev / 1000000; });
                var bizCostData = rows.map(function(r) { return r.costBiz / 1000000; });
                var traceDevCost = {
                    x: labels, y: devCostData,
                    name: 'ê°œë°œë¹„', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(55, 128, 191)' },
                    fillcolor: 'rgba(55, 128, 191, 0.6)',
                    hovertemplate: '%{x}<br>ê°œë°œë¹„: %{y:,.0f} ë°±ë§Œì›<extra></extra>'
                };
                var traceBizCost = {
                    x: labels, y: bizCostData,
                    name: 'ì‚¬ì—…ë¹„', type: 'scatter', mode: 'lines',
                    stackgroup: 'one',
                    line: { color: 'rgb(219, 64, 82)' },
                    fillcolor: 'rgba(219, 64, 82, 0.6)',
                    hovertemplate: '%{x}<br>ì‚¬ì—…ë¹„: %{y:,.0f} ë°±ë§Œì›<extra></extra>'
                };
                var lastLabel = labels[labels.length - 1] || launch;
                var costLayout = {
                    title: { text: projectName + ' â€” ëˆ„ì  ê°œë°œë¹„ í˜„í™©', font: { size: 16 }, y: 0.98 },
                    xaxis: {
                        title: '',
                        tickangle: -45,
                        tickformat: '%Y-%m',
                        tickfont: { size: 10 },
                        nticks: 40,
                        ticklabeloverflow: 'allow'
                    },
                    yaxis: { title: 'ëˆ„ì  ê°œë°œë¹„ (ë°±ë§Œì›)' },
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.25, yanchor: 'top' },
                    margin: { t: 60, b: 90, l: 80, r: 20 },
                    shapes: [
                        {
                            type: 'rect',
                            x0: currentDate, x1: lastLabel,
                            y0: 0, y1: 1, yref: 'paper',
                            fillcolor: 'rgba(255, 255, 255, 0.45)',
                            line: { width: 0 },
                            layer: 'above'
                        },
                        {
                            type: 'line',
                            x0: currentDate, x1: currentDate,
                            y0: 0, y1: 1, yref: 'paper',
                            line: { color: 'rgba(0,0,0,0.5)', width: 2, dash: 'dash' },
                            layer: 'above'
                        }
                    ],
                    annotations: [{
                        x: currentDate, y: 1.02, yref: 'paper',
                        text: 'â—€ ì‹¤ì  | ì˜ˆì¸¡ â–¶',
                        showarrow: false,
                        font: { size: 11, color: 'rgba(0,0,0,0.6)' },
                        yanchor: 'bottom'
                    }]
                };
                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, [traceDevCost, traceBizCost], costLayout, { responsive: true });
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }
            // â”€â”€â”€â”€â”€â”€â”€â”€ BAR CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'bar') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';
                // ê¸°ì¤€ì›” ê¸°ì¤€ ìµœê·¼ 6ê°œì›” í•„í„°ë§ (currentDate í¬í•¨ ì´ì „ 5ê°œì›”)
                function subtractMonths(ym, n) {
                    var p = ym.split('-');
                    var y = parseInt(p[0]), mo = parseInt(p[1]) - 1 - n;
                    while (mo < 0) { mo += 12; y--; }
                    return y + '-' + ('0' + (mo + 1)).slice(-2);
                }
                var fromDate = subtractMonths(currentDate, 5);
                var barRows = rows.filter(function(r) {
                    return r.date >= fromDate && r.date <= currentDate;
                });
                if (barRows.length === 0 || !barRows[0].costBreakdown) {
                    contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ í•­ëª©ë³„ ë¹„ìš© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>admin.htmlì—ì„œ ë¹„ìš© ì‹œíŠ¸ëª…ì„ ì…ë ¥í•˜ê³  ë‹¤ì‹œ JSONì„ ìƒì„±í•´ ì£¼ì„¸ìš”.</p></div>';
                    return;
                }
                var bLabels = barRows.map(function(r) { return r.date; });
                var K = 1000; // ì²œì› ë‹¨ìœ„ ë³€í™˜ (/1000)
                var categories = [
                    { key: 'labor',        name: 'ì¸ê±´ë¹„',     color: 'rgb(55,128,191)'  },
                    { key: 'marketing',    name: 'ë§ˆì¼€íŒ…ë¹„',   color: 'rgb(243,156,18)'  },
                    { key: 'outsourcing',  name: 'ì™¸ì£¼ë¹„',     color: 'rgb(39,174,96)'   },
                    { key: 'depreciation', name: 'ê°ê°€ìƒê°ë¹„', color: 'rgb(142,68,173)'  },
                    { key: 'server',       name: 'ì„œë²„ë¹„',     color: 'rgb(22,160,133)'  },
                    { key: 'other',        name: 'ê¸°íƒ€ ìš´ì˜ë¹„',color: 'rgb(127,140,141)' }
                ];
                var barTraces = categories.map(function(cat) {
                    var yVals = barRows.map(function(r) {
                        var bd = r.costBreakdown || {};
                        return (bd[cat.key] || 0) / K;
                    });
                    return {
                        x: bLabels,
                        y: yVals,
                        text: yVals.map(function(v) { return v > 0 ? Math.round(v).toLocaleString() : ''; }),
                        textposition: 'inside',
                        insidetextanchor: 'middle',
                        textfont: { size: 9, color: '#fff' },
                        name: cat.name,
                        type: 'bar',
                        marker: { color: cat.color },
                        hovertemplate: '%{x}<br>' + cat.name + ': %{y:,.0f} ì²œì›<extra></extra>'
                    };
                });
                var barLayout = {
                    title: { text: projectName + ' â€” ì›”ë³„ ê°œë°œë¹„ í˜„í™© (ë‹¨ìœ„:ì²œì›)', font: { size: 16 }, y: 0.98 },
                    barmode: 'stack',
                    xaxis: {
                        title: '',
                        tickangle: -30,
                        tickfont: { size: 11 },
                        ticklabeloverflow: 'allow'
                    },
                    yaxis: { title: 'ê°œë°œë¹„ (ì²œì›)' },
                    bargap: 0.5,
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.2, yanchor: 'top', traceorder: 'normal' },
                    margin: { t: 60, b: 80, l: 80, r: 20 }
                };
                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, barTraces, barLayout, { responsive: true });
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }
            // â”€â”€â”€â”€â”€â”€â”€â”€ PIE CHART â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'pie') {
                contentDiv.classList.remove('table-mode');
                contentDiv.innerHTML = '<div id="chart"></div>';
                var monthParam = params.get('month'); // null ë˜ëŠ” 'prev'
                function subtractOneMonth(ym) {
                    var p = ym.split('-');
                    var y = parseInt(p[0]), mo = parseInt(p[1]) - 2;
                    if (mo < 0) { mo = 11; y--; }
                    return y + '-' + ('0' + (mo + 1)).slice(-2);
                }
                var targetDate = (monthParam === 'prev') ? subtractOneMonth(currentDate) : currentDate;
                var targetRow = null;
                for (var ri = 0; ri < rows.length; ri++) {
                    if (rows[ri].date === targetDate) { targetRow = rows[ri]; break; }
                }
                if (!targetRow || !targetRow.costBreakdown) {
                    contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ' + targetDate + ' ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h2><p>admin.htmlì—ì„œ ë¹„ìš© ì‹œíŠ¸ëª…ì„ ì…ë ¥í•˜ê³  ë‹¤ì‹œ JSONì„ ìƒì„±í•´ ì£¼ì„¸ìš”.</p></div>';
                    return;
                }
                var pieCategories = [
                    { key: 'labor',        name: 'ì¸ê±´ë¹„',     color: 'rgb(55,128,191)'  },
                    { key: 'marketing',    name: 'ë§ˆì¼€íŒ…ë¹„',   color: 'rgb(243,156,18)'  },
                    { key: 'outsourcing',  name: 'ì™¸ì£¼ë¹„',     color: 'rgb(39,174,96)'   },
                    { key: 'depreciation', name: 'ê°ê°€ìƒê°ë¹„', color: 'rgb(142,68,173)'  },
                    { key: 'server',       name: 'ì„œë²„ë¹„',     color: 'rgb(22,160,133)'  },
                    { key: 'other',        name: 'ê¸°íƒ€ ìš´ì˜ë¹„',color: 'rgb(127,140,141)' }
                ];
                var bd = targetRow.costBreakdown;
                var K = 1000;
                var pieLabels = pieCategories.map(function(c) { return c.name; });
                var pieValues = pieCategories.map(function(c) { return (bd[c.key] || 0) / K; });
                var pieColors = pieCategories.map(function(c) { return c.color; });
                // ì œëª©: YYë…„ MMì›”
                var tp = targetDate.split('-');
                var yy = tp[0].slice(2);
                var mm = parseInt(tp[1]);
                var titleDate = yy + 'ë…„ ' + mm + 'ì›”';
                var pieTrace = {
                    labels: pieLabels,
                    values: pieValues,
                    type: 'pie',
                    marker: { colors: pieColors },
                    textinfo: 'percent',
                    textposition: 'inside',
                    texttemplate: '%{percent:.1%}',
                    hovertemplate: '%{label}<br>%{value:,.0f} ì²œì›<extra></extra>',
                    insidetextorientation: 'horizontal'
                };
                var pieLayout = {
                    title: { text: titleDate + ' ' + projectName + ' ê°œë°œë¹„ í•­ëª©ë³„ ë¹„ì¤‘ (%)', font: { size: 15 }, y: 0.98 },
                    legend: { orientation: 'h', x: 0.5, xanchor: 'center', y: -0.05, yanchor: 'top', traceorder: 'normal' },
                    margin: { t: 60, b: 80, l: 20, r: 20 },
                    paper_bgcolor: '#ffffff',
                    plot_bgcolor: '#ffffff'
                };
                var chartDiv = document.getElementById('chart');
                Plotly.newPlot(chartDiv, [pieTrace], pieLayout, { responsive: true });
                window.addEventListener('resize', function() {
                    Plotly.relayout(chartDiv, { width: window.innerWidth, height: window.innerHeight });
                });
            }
            // â”€â”€â”€â”€â”€â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€
            else if (viewType === 'dashboard') {
                // ìŠ¤í¬ë¡¤ í—ˆìš©
                document.documentElement.style.overflow = 'auto';
                document.documentElement.style.height = 'auto';
                document.body.style.overflow = 'auto';
                document.body.style.height = 'auto';
                contentDiv.style.height = 'auto';
                contentDiv.style.width = '100%';
                contentDiv.innerHTML =
                    '<div class="dash-header">ğŸ“Š ' + projectName + ' â€” ê°œë°œ í˜„í™© ëŒ€ì‹œë³´ë“œ</div>'
                    + '<div class="dash-grid">'
                    + '<div class="dash-item" id="d-mm"></div>'
                    + '<div class="dash-item" id="d-cost"></div>'
                    + '<div class="dash-item full-width" id="d-bar"></div>'
                    + '<div class="dash-item" id="d-pie-cur"></div>'
                    + '<div class="dash-item" id="d-pie-prev"></div>'
                    + '</div>'
                    + '<div id="d-urls" class="dash-urls"></div>';
                var labels = rows.map(function(r) { return r.date; });
                var lastLabel = labels[labels.length - 1] || launch;
                var shapeRect = { type:'rect', x0:currentDate, x1:lastLabel, y0:0, y1:1, yref:'paper', fillcolor:'rgba(255,255,255,0.45)', line:{width:0}, layer:'above' };
                var shapeLine = { type:'line', x0:currentDate, x1:currentDate, y0:0, y1:1, yref:'paper', line:{color:'rgba(0,0,0,0.5)',width:2,dash:'dash'}, layer:'above' };
                var annotCur  = { x:currentDate, y:1.02, yref:'paper', text:'â—€ ì‹¤ì  | ì˜ˆì¸¡ â–¶', showarrow:false, font:{size:10,color:'rgba(0,0,0,0.6)'}, yanchor:'bottom' };
                var commonCfg = { responsive: true };
                // â”€â”€ MM ì°¨íŠ¸ â”€â”€
                Plotly.newPlot('d-mm', [
                    { x:labels, y:rows.map(function(r){return r.mmDev;}), name:'ê°œë°œ MM', type:'scatter', mode:'lines', stackgroup:'one', line:{color:'rgb(55,128,191)'}, fillcolor:'rgba(55,128,191,0.6)', hovertemplate:'%{x}<br>ê°œë°œ MM: %{y:.1f}<extra></extra>' },
                    { x:labels, y:rows.map(function(r){return r.mmBiz;}), name:'ì‚¬ì—… MM', type:'scatter', mode:'lines', stackgroup:'one', line:{color:'rgb(219,64,82)'}, fillcolor:'rgba(219,64,82,0.6)', hovertemplate:'%{x}<br>ì‚¬ì—… MM: %{y:.1f}<extra></extra>' }
                ], {
                    title: { text:'ì›”ë³„ MM í˜„í™©', font:{size:14}, y:0.97 },
                    xaxis: { tickangle:-45, tickformat:'%Y-%m', tickfont:{size:9}, nticks:20 },
                    yaxis: { title:'MM' },
                    legend: { orientation:'h', x:0.5, xanchor:'center', y:-0.28, yanchor:'top', traceorder:'normal' },
                    margin: { t:48, b:75, l:55, r:10 },
                    shapes: [shapeRect, shapeLine], annotations: [annotCur],
                    paper_bgcolor:'#fff', plot_bgcolor:'#fff'
                }, commonCfg);
                // â”€â”€ ëˆ„ì  ê°œë°œë¹„ ì°¨íŠ¸ â”€â”€
                Plotly.newPlot('d-cost', [
                    { x:labels, y:rows.map(function(r){return r.costDev/1000000;}), name:'ê°œë°œë¹„', type:'scatter', mode:'lines', stackgroup:'one', line:{color:'rgb(55,128,191)'}, fillcolor:'rgba(55,128,191,0.6)', hovertemplate:'%{x}<br>ê°œë°œë¹„: %{y:,.0f} ë°±ë§Œì›<extra></extra>' },
                    { x:labels, y:rows.map(function(r){return r.costBiz/1000000;}), name:'ì‚¬ì—…ë¹„', type:'scatter', mode:'lines', stackgroup:'one', line:{color:'rgb(219,64,82)'}, fillcolor:'rgba(219,64,82,0.6)', hovertemplate:'%{x}<br>ì‚¬ì—…ë¹„: %{y:,.0f} ë°±ë§Œì›<extra></extra>' }
                ], {
                    title: { text:'ëˆ„ì  ê°œë°œë¹„ í˜„í™©', font:{size:14}, y:0.97 },
                    xaxis: { tickangle:-45, tickformat:'%Y-%m', tickfont:{size:9}, nticks:20 },
                    yaxis: { title:'ë°±ë§Œì›' },
                    legend: { orientation:'h', x:0.5, xanchor:'center', y:-0.28, yanchor:'top', traceorder:'normal' },
                    margin: { t:48, b:75, l:65, r:10 },
                    shapes: [shapeRect, shapeLine], annotations: [annotCur],
                    paper_bgcolor:'#fff', plot_bgcolor:'#fff'
                }, commonCfg);
                // â”€â”€ ì›”ë³„ ë§‰ëŒ€ ì°¨íŠ¸ â”€â”€
                (function() {
                    function subM(ym, n) {
                        var p=ym.split('-'); var y=parseInt(p[0]), mo=parseInt(p[1])-1-n;
                        while(mo<0){mo+=12;y--;} return y+'-'+('0'+(mo+1)).slice(-2);
                    }
                    var fromDate = subM(currentDate, 5);
                    var barRows = rows.filter(function(r){return r.date>=fromDate && r.date<=currentDate;});
                    if (!barRows.length || !barRows[0].costBreakdown) {
                        document.getElementById('d-bar').innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#e53e3e;font-size:13px;">âš ï¸ í•­ëª©ë³„ ë¹„ìš© ë°ì´í„° ì—†ìŒ â€” ë¹„ìš© ì‹œíŠ¸ëª… ì…ë ¥ í›„ JSON ì¬ìƒì„± í•„ìš”</div>';
                        return;
                    }
                    var bLabels = barRows.map(function(r){return r.date;});
                    var K = 1000;
                    var cats = [
                        {key:'labor',        name:'ì¸ê±´ë¹„',     color:'rgb(55,128,191)'},
                        {key:'marketing',    name:'ë§ˆì¼€íŒ…ë¹„',   color:'rgb(243,156,18)'},
                        {key:'outsourcing',  name:'ì™¸ì£¼ë¹„',     color:'rgb(39,174,96)'},
                        {key:'depreciation', name:'ê°ê°€ìƒê°ë¹„', color:'rgb(142,68,173)'},
                        {key:'server',       name:'ì„œë²„ë¹„',     color:'rgb(22,160,133)'},
                        {key:'other',        name:'ê¸°íƒ€ ìš´ì˜ë¹„',color:'rgb(127,140,141)'}
                    ];
                    var bTraces = cats.map(function(cat) {
                        var yv = barRows.map(function(r){return (r.costBreakdown[cat.key]||0)/K;});
                        return { x:bLabels, y:yv, text:yv.map(function(v){return v>0?Math.round(v).toLocaleString():''}), textposition:'inside', insidetextanchor:'middle', textfont:{size:8,color:'#fff'}, name:cat.name, type:'bar', marker:{color:cat.color}, hovertemplate:'%{x}<br>'+cat.name+': %{y:,.0f} ì²œì›<extra></extra>' };
                    });
                    Plotly.newPlot('d-bar', bTraces, {
                        title: { text:'ì›”ë³„ ê°œë°œë¹„ í˜„í™© (ë‹¨ìœ„:ì²œì›)', font:{size:14}, y:0.97 },
                        barmode:'stack',
                        xaxis: { tickangle:-30, tickfont:{size:10} },
                        yaxis: { title:'ì²œì›' },
                        bargap: 0.5,
                        legend: { orientation:'h', x:0.5, xanchor:'center', y:-0.18, yanchor:'top', traceorder:'normal' },
                        margin: { t:48, b:65, l:70, r:10 },
                        paper_bgcolor:'#fff', plot_bgcolor:'#fff'
                    }, commonCfg);
                })();
                // â”€â”€ íŒŒì´ ì°¨íŠ¸ (ì´ë²ˆë‹¬ / ì§€ë‚œë‹¬) â”€â”€
                (function() {
                    function subOneM(ym) {
                        var p=ym.split('-'); var y=parseInt(p[0]),mo=parseInt(p[1])-2;
                        if(mo<0){mo=11;y--;} return y+'-'+('0'+(mo+1)).slice(-2);
                    }
                    var pieCats = [
                        {key:'labor',        name:'ì¸ê±´ë¹„',     color:'rgb(55,128,191)'},
                        {key:'marketing',    name:'ë§ˆì¼€íŒ…ë¹„',   color:'rgb(243,156,18)'},
                        {key:'outsourcing',  name:'ì™¸ì£¼ë¹„',     color:'rgb(39,174,96)'},
                        {key:'depreciation', name:'ê°ê°€ìƒê°ë¹„', color:'rgb(142,68,173)'},
                        {key:'server',       name:'ì„œë²„ë¹„',     color:'rgb(22,160,133)'},
                        {key:'other',        name:'ê¸°íƒ€ ìš´ì˜ë¹„',color:'rgb(127,140,141)'}
                    ];
                    var pieLabels = pieCats.map(function(c){return c.name;});
                    var pieColors = pieCats.map(function(c){return c.color;});
                    var K = 1000;
                    function renderPie(cId, targetDate) {
                        var tRow = null;
                        for(var ri=0;ri<rows.length;ri++){if(rows[ri].date===targetDate){tRow=rows[ri];break;}}
                        if(!tRow || !tRow.costBreakdown) {
                            document.getElementById(cId).innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#e53e3e;font-size:13px;">âš ï¸ '+targetDate+' ë°ì´í„° ì—†ìŒ</div>';
                            return;
                        }
                        var bd=tRow.costBreakdown;
                        var tp=targetDate.split('-'); var yy=tp[0].slice(2); var mm=parseInt(tp[1]);
                        Plotly.newPlot(cId, [{
                            labels: pieLabels,
                            values: pieCats.map(function(c){return (bd[c.key]||0)/K;}),
                            type:'pie', marker:{colors:pieColors},
                            textinfo:'percent', textposition:'inside',
                            texttemplate:'%{percent:.1%}',
                            hovertemplate:'%{label}<br>%{value:,.0f} ì²œì›<extra></extra>',
                            insidetextorientation:'horizontal',
                            sort: false,
                            direction: 'clockwise'
                        }], {
                            title: { text:yy+'ë…„ '+mm+'ì›” ê°œë°œë¹„ í•­ëª©ë³„ ë¹„ì¤‘', font:{size:14}, y:0.97 },
                            legend: { orientation:'h', x:0.5, xanchor:'center', y:-0.05, yanchor:'top', traceorder:'normal' },
                            margin: { t:48, b:60, l:10, r:10 },
                            paper_bgcolor:'#ffffff', plot_bgcolor:'#ffffff'
                        }, commonCfg);
                    }
                    renderPie('d-pie-cur',  currentDate);
                    renderPie('d-pie-prev', subOneM(currentDate));
                    // â”€â”€ ì„ë² ë“œ URL í‘œì‹œ â”€â”€
                    (function() {
                        var p = window.location.href.split('?')[0];
                        var base = p.substring(0, p.lastIndexOf('/'));
                        var enc = encodeURIComponent(projectName);
                        var urls = [
                            { label: 'í‘œ',         url: base + '/view.html?project=' + enc + '&type=table' },
                            { label: 'MM',         url: base + '/view.html?project=' + enc + '&type=chart' },
                            { label: 'ë¹„ìš©',       url: base + '/view.html?project=' + enc + '&type=cost' },
                            { label: 'ë§‰ëŒ€',       url: base + '/view.html?project=' + enc + '&type=bar' },
                            { label: 'íŒŒì´(ê¸°ì¤€)', url: base + '/view.html?project=' + enc + '&type=pie' },
                            { label: 'íŒŒì´(ì „ë‹¬)', url: base + '/view.html?project=' + enc + '&type=pie&month=prev' },
                            { label: 'ëŒ€ì‹œë³´ë“œ',   url: base + '/view.html?project=' + enc + '&type=dashboard' }
                        ];
                        var html = '<h4>ğŸ“‹ ë…¸ì…˜ ì„ë² ë“œ URL â€” ' + projectName + '</h4>';
                        urls.forEach(function(u) {
                            html += '<div class="dash-url-row">'
                                + '<span class="url-label">' + u.label + '</span>'
                                + '<code>' + u.url + '</code>'
                                + '<button class="copy-btn" data-url="' + u.url + '">ë³µì‚¬</button>'
                                + '</div>';
                        });
                        document.getElementById('d-urls').innerHTML = html;
                        document.querySelectorAll('#d-urls .copy-btn').forEach(function(btn) {
                            btn.addEventListener('click', function() {
                                var self = this;
                                navigator.clipboard.writeText(self.getAttribute('data-url')).then(function() {
                                    self.textContent = 'âœ“';
                                    setTimeout(function() { self.textContent = 'ë³µì‚¬'; }, 1500);
                                });
                            });
                        });
                    })();
                })();
            }
            else {
                contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” type: ' + viewType + '</h2><p>table, chart, cost, bar, pie, ë˜ëŠ” dashboardë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.</p></div>';
            }
        })
        .catch(function(err) {
            contentDiv.innerHTML = '<div class="error"><h2>âš ï¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</h2><p>' + err.message + '</p><p style="margin-top:8px; color:#666; font-size:13px;">data/projects.json íŒŒì¼ì´ ë ˆí¬ì— ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.</p></div>';
        });
})();
</script>
</body>
</html>
