<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ë°ì´í„° ê´€ë¦¬ì</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        h1 { text-align: center; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 24px; font-size: 14px; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 1100px; margin: 0 auto; }
        .section { margin-bottom: 24px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #eee; }
        .section-title .badge { font-size: 12px; background: #e0e0e0; color: #555; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 400; }
        .file-area { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .file-area input[type="file"] { font-size: 14px; }
        .file-area .status { font-size: 13px; color: #888; }
        #project-list { display: flex; flex-direction: column; gap: 10px; }
        .project-card { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa; flex-wrap: wrap; }
        .project-card.selected { border-color: #007bff; background: #f0f7ff; }
        .project-card input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
        .project-card .name { font-weight: 500; min-width: 150px; font-size: 14px; }
        .project-card .dates { display: flex; gap: 6px; font-size: 12px; flex-wrap: wrap; align-items: center; }
        .project-card .dates label { color: #666; }
        .project-card .dates input[type="month"] { font-size: 12px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; width: 120px; }
        .project-card .sheet-wrap { display: flex; align-items: center; gap: 4px; font-size: 12px; }
        .project-card .sheet-wrap label { color: #666; white-space: nowrap; }
        .project-card .sheet-wrap input[type="text"] { font-size: 12px; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px; width: 160px; background: #fffbe6; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn { font-size: 15px; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #545b62; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #url-output { margin-top: 20px; }
        .url-group { margin-bottom: 16px; }
        .url-group h4 { margin-bottom: 6px; color: #333; }
        .url-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .url-row code { flex: 1; background: #f5f5f5; padding: 8px 12px; border-radius: 4px; font-size: 13px; word-break: break-all; border: 1px solid #e0e0e0; }
        .url-row .copy-btn { font-size: 12px; padding: 6px 12px; background: #17a2b8; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .url-row .copy-btn:hover { background: #138496; }
        .msg { padding: 10px 16px; border-radius: 6px; margin-top: 12px; font-size: 14px; }
        .msg-success { background: #d4edda; color: #155724; }
        .msg-info { background: #d1ecf1; color: #0c5460; }
        .msg-warn { background: #fff3cd; color: #856404; }
        .msg-error { background: #f8d7da; color: #721c24; }
        #storage-info { font-size: 13px; color: #888; text-align: center; margin-top: 10px; }
        .github-url-input { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .github-url-input label { font-weight: 500; font-size: 14px; white-space: nowrap; }
        .github-url-input input { font-size: 14px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        .github-url-preview { font-size: 12px; color: #555; background: #f0f7ff; border: 1px solid #b8d9f8; border-radius: 4px; padding: 6px 10px; margin-bottom: 12px; word-break: break-all; }
        /* â”€â”€ 4ï¸âƒ£ ì°¨íŠ¸ ì„¤ì • â”€â”€ */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
        @media (max-width: 720px) { .settings-grid { grid-template-columns: 1fr; } }
        .subsection-title { font-size: 13px; font-weight: 600; color: #444; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #eee; }
        .series-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .series-table th { padding: 5px 8px; background: #f0f0f0; font-weight: 600; text-align: left; font-size: 12px; }
        .series-table td { padding: 4px 8px; border-bottom: 1px solid #f2f2f2; vertical-align: middle; }
        .series-table .group-hd td { background: #f8f8f8; font-weight: 600; font-size: 11px; color: #777; padding: 3px 8px; }
        input[type="color"] { width: 34px; height: 26px; padding: 1px 2px; border: 1px solid #ccc; border-radius: 3px; cursor: pointer; vertical-align: middle; }
        .op-slider { width: 90px; vertical-align: middle; }
        .oval { font-size: 11px; color: #666; min-width: 28px; display: inline-block; }
        .axis-block { margin-bottom: 10px; border: 1px solid #eee; border-radius: 5px; padding: 8px 10px; }
        .axis-block-title { font-size: 12px; font-weight: 600; color: #555; margin-bottom: 6px; }
        .axis-row2 { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap; }
        .axis-row2 label { font-size: 12px; color: #666; }
        .axis-row2 input[type="number"] { width: 72px; font-size: 12px; padding: 3px 6px; border: 1px solid #ccc; border-radius: 3px; }
        .xfmt-row { display: flex; align-items: center; gap: 14px; flex-wrap: wrap; }
        .xfmt-row label { font-size: 12px; color: #555; cursor: pointer; }
        .preview-wrap { border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; background: #fafafa; display: flex; flex-direction: column; }
        .preview-tabs { display: flex; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; }
        .preview-tab { font-size: 12px; padding: 4px 12px; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; background: #fff; }
        .preview-tab.active { background: #007bff; color: #fff; border-color: #007bff; }
        #preview-canvas-wrap { position: relative; height: 300px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š í”„ë¡œì íŠ¸ ë°ì´í„° ê´€ë¦¬ì</h1>
    <p class="subtitle">ì—‘ì…€ â†’ projects.json ë‹¤ìš´ë¡œë“œ Â· ì°¨íŠ¸ ì„¤ì • â†’ settings.json ë‹¤ìš´ë¡œë“œ â†’ GitHub Pages â†’ ë…¸ì…˜ ì„ë² ë“œ</p>

    <!-- STEP 1: íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="section">
        <div class="section-title">1ï¸âƒ£ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</div>
        <div class="file-area">
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <span class="status" id="file-status">íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</span>
        </div>
    </div>

    <!-- STEP 2: í”„ë¡œì íŠ¸ ì„ íƒ -->
    <div class="section">
        <div class="section-title">2ï¸âƒ£ í”„ë¡œì íŠ¸ ì„ íƒ ë° ê¸°ê°„ ì„¤ì • <span class="badge" id="project-count">0ê°œ íƒì§€</span></div>
        <p style="font-size:12px; color:#888; margin-bottom:8px;">ğŸ’¡ <strong>ë¹„ìš© ì‹œíŠ¸ëª…</strong>: costDev ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ì‹œíŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ ê¸°ì¡´ ì‹œíŠ¸ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        <div id="project-list">
            <p style="color:#aaa; font-size:14px;">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ í”„ë¡œì íŠ¸ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        <div class="btn-group" style="justify-content:flex-start; margin-top:10px;">
            <button class="btn btn-secondary" id="selectAllBtn" style="font-size:13px; padding:6px 14px;" disabled>ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" id="deselectAllBtn" style="font-size:13px; padding:6px 14px;" disabled>ì „ì²´ í•´ì œ</button>
        </div>
    </div>

    <!-- STEP 3: JSON ë‹¤ìš´ë¡œë“œ & URL ìƒì„± -->
    <div class="section">
        <div class="section-title">3ï¸âƒ£ JSON ë‹¤ìš´ë¡œë“œ ë° ì„ë² ë“œ URL ìƒì„±</div>
        <div class="github-url-input">
            <label>GitHub ê³„ì •ëª…:</label>
            <input type="text" id="accountInput" placeholder="ì˜ˆ: whiteworld33">
            <label style="margin-left:8px;">ë ˆí¬ëª…:</label>
            <input type="text" id="repoInput" placeholder="ì˜ˆ: project-viewer">
        </div>
        <div class="github-url-preview" id="urlPreview">ğŸ”— ìƒì„±ë  ê¸°ë³¸ URL: <strong>ê³„ì •ëª…ê³¼ ë ˆí¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</strong></div>
        <div class="btn-group">
            <button class="btn btn-success" id="downloadBtn" disabled>ğŸ“¥ projects.json ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-primary" id="generateUrlBtn" disabled>ğŸ”— ì„ë² ë“œ URL ìƒì„±</button>
        </div>
        <div id="save-msg"></div>
        <div id="storage-info"></div>
        <div id="url-output"></div>
    </div>

    <!-- STEP 4: ì°¨íŠ¸ ì„¤ì • & ë¯¸ë¦¬ë³´ê¸° -->
    <div class="section">
        <div class="section-title">4ï¸âƒ£ ì°¨íŠ¸ ì„¤ì • &amp; ë¯¸ë¦¬ë³´ê¸°</div>
        <p style="font-size:12px; color:#888; margin-bottom:14px;">ğŸ’¡ ì„¤ì • ì™„ë£Œ í›„ <strong>settings.json ë‹¤ìš´ë¡œë“œ</strong> â†’ GitHub ë ˆí¬ <code>data/</code> í´ë”ì— push í•˜ë©´, ëª¨ë“  í”„ë¡œì íŠ¸ ì°¨íŠ¸ì— ê³µí†µ ì ìš©ë©ë‹ˆë‹¤. settings.jsonì´ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.</p>
        <div class="settings-grid">
            <div>
                <div class="subsection-title">ğŸ“Š ì‹œë¦¬ì¦ˆ ìƒ‰ìƒ / íˆ¬ëª…ë„</div>
                <table class="series-table" id="series-table">
                    <thead><tr><th>ì‹œë¦¬ì¦ˆ</th><th>ìƒ‰ìƒ</th><th>íˆ¬ëª…ë„</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
                <div style="margin-top:16px;">
                    <div class="subsection-title">ğŸ“ Yì¶• ì„¤ì •</div>
                    <div id="axis-settings"></div>
                    <div style="margin-top:12px;">
                        <div class="subsection-title">ğŸ“… Xì¶• ë‚ ì§œ í¬ë§·</div>
                        <div class="xfmt-row" id="xfmt-row"></div>
                    </div>
                </div>
            </div>
            <div>
                <div class="subsection-title">ğŸ‘ ì‹¤ì‹œê°„ ë¯¸ë¦¬ë³´ê¸°</div>
                <div class="preview-wrap">
                    <div class="preview-tabs">
                        <button class="preview-tab active" data-type="mm">MM</button>
                        <button class="preview-tab" data-type="cost">ë¹„ìš©</button>
                        <button class="preview-tab" data-type="bar">ë§‰ëŒ€</button>
                        <button class="preview-tab" data-type="pie">íŒŒì´</button>
                    </div>
                    <div id="preview-canvas-wrap"><canvas id="previewChart"></canvas></div>
                </div>
            </div>
        </div>
        <div class="btn-group">
            <button class="btn btn-primary" id="downloadSettingsBtn">ğŸ“¥ settings.json ë‹¤ìš´ë¡œë“œ</button>
        </div>
        <div id="settings-msg"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    function excelDateToYM(serial) {
        if (typeof serial !== 'number') return null;
        if (serial > 59) serial -= 1;
        var d = new Date((serial - 25568) * 86400 * 1000);
        return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2);
    }

    var parsedProjects = {};
    var workbook = null;
    var lastSaveData = null;

    // â”€â”€ STEP 1: íŒŒì¼ ì—…ë¡œë“œ â”€â”€
    document.getElementById('fileInput').addEventListener('change', function() {
        var file = this.files[0];
        if (!file) return;
        document.getElementById('file-status').textContent = 'íŒŒì‹± ì¤‘...';
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, { type: 'array' });
                var sheetName = 'ê°œë°œì „ëµê¸°íšì‹¤';
                var ws = workbook.Sheets[sheetName];
                if (!ws) throw new Error("'" + sheetName + "' ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                var sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
                parsedProjects = {};
                for (var i = 0; i < sheet.length; i++) {
                    for (var j = 0; j < (sheet[i] || []).length; j++) {
                        var cellVal = (sheet[i][j] || '').toString().trim();
                        if (!cellVal || typeof sheet[i][j] === 'number') continue;
                        var dataRow = i + 5;
                        if (dataRow >= sheet.length) continue;
                        var checkVal = (sheet[dataRow] || [])[j];
                        if (typeof checkVal !== 'number' || checkVal < 30000 || checkVal > 60000) continue;
                        var rows = [];
                        for (var r = dataRow; r < sheet.length; r++) {
                            var rv = (sheet[r] || [])[j];
                            if (rv === null || typeof rv !== 'number') break;
                            var ym = excelDateToYM(rv);
                            if (!ym) break;
                            var row = sheet[r] || [];
                            rows.push({ date: ym, mmDev: row[j+1]||0, mmBiz: row[j+2]||0, mmTotal: row[j+3]||0, costDev: row[j+4]||0, costBiz: row[j+5]||0, costTotal: row[j+6]||0 });
                        }
                        if (rows.length > 0) {
                            parsedProjects[cellVal] = { rows: rows, firstDate: rows[0].date, lastDate: rows[rows.length-1].date };
                        }
                    }
                }
                var names = Object.keys(parsedProjects);
                document.getElementById('file-status').textContent = file.name + ' (' + names.length + 'ê°œ í”„ë¡œì íŠ¸ íƒì§€)';
                document.getElementById('project-count').textContent = names.length + 'ê°œ íƒì§€';
                renderProjectList(names);
            } catch(err) {
                document.getElementById('file-status').textContent = 'ì˜¤ë¥˜: ' + err.message;
                document.getElementById('project-list').innerHTML = '<p style="color:red;">' + err.message + '</p>';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    function renderProjectList(names) {
        var container = document.getElementById('project-list');
        if (names.length === 0) { container.innerHTML = '<p style="color:#aaa;">íƒì§€ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        var now = new Date();
        var currentYM = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
        container.innerHTML = names.map(function(name) {
            var p = parsedProjects[name];
            return '<div class="project-card" data-name="' + name + '">'
                + '<input type="checkbox" class="proj-check">'
                + '<span class="name">' + name + '</span>'
                + '<a class="gh-link" href="#" target="_blank" style="font-size:12px;color:#007bff;text-decoration:none;margin-left:6px;display:none;">ğŸ”— ë³´ê¸°</a>'
                + '<div class="dates">'
                + '<div><label>í‚¥ì˜¤í”„</label><input type="month" class="dt-kickoff" value="' + p.firstDate + '"></div>'
                + '<div><label>ê¸°ì¤€ì›”</label><input type="month" class="dt-current" value="' + currentYM + '"></div>'
                + '<div><label>ëŸ°ì¹­</label><input type="month" class="dt-launch" value="' + p.lastDate + '"></div>'
                + '</div>'
                + '<div class="sheet-wrap"><label>ë¹„ìš© ì‹œíŠ¸ëª…</label><input type="text" class="dt-sheet" placeholder="ì‹œíŠ¸ëª… ì…ë ¥"></div>'
                + '</div>';
        }).join('');
        container.querySelectorAll('.project-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
                var cb = card.querySelector('.proj-check');
                cb.checked = !cb.checked;
                card.classList.toggle('selected', cb.checked);
                updateBtns();
            });
            card.querySelector('.proj-check').addEventListener('change', function() {
                card.classList.toggle('selected', this.checked);
                updateBtns();
            });
        });
        document.getElementById('selectAllBtn').disabled = false;
        document.getElementById('deselectAllBtn').disabled = false;
        updateBtns();
        updateProjectLinks();
    }

    function updateBtns() {
        var checked = document.querySelectorAll('.proj-check:checked').length;
        document.getElementById('downloadBtn').disabled = (checked === 0);
        document.getElementById('generateUrlBtn').disabled = (checked === 0);
    }

    function getBaseUrl() {
        var account = document.getElementById('accountInput').value.trim().replace(/\/+$/, '');
        var repo    = document.getElementById('repoInput').value.trim().replace(/\/+$/, '');
        if (!account || !repo) return '';
        return 'https://' + account + '.github.io/' + repo;
    }
    function updateUrlPreview() {
        var base = getBaseUrl();
        var preview = document.getElementById('urlPreview');
        if (base) { preview.innerHTML = 'ğŸ”— ìƒì„±ë  ê¸°ë³¸ URL: <strong>' + base + '</strong>'; }
        else { preview.innerHTML = 'ğŸ”— ìƒì„±ë  ê¸°ë³¸ URL: <strong>ê³„ì •ëª…ê³¼ ë ˆí¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</strong>'; }
    }
    function updateProjectLinks() {
        var base = getBaseUrl();
        document.querySelectorAll('.project-card').forEach(function(card) {
            var name = card.getAttribute('data-name');
            var link = card.querySelector('.gh-link');
            if (!link) return;
            if (base && name) { link.href = base + '/view.html?project=' + encodeURIComponent(name) + '&type=dashboard'; link.style.display = 'inline'; }
            else { link.href = '#'; link.style.display = 'none'; }
        });
        updateUrlPreview();
    }
    document.getElementById('accountInput').addEventListener('input', updateProjectLinks);
    document.getElementById('repoInput').addEventListener('input', updateProjectLinks);
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.proj-check').forEach(function(cb) { cb.checked = true; cb.closest('.project-card').classList.add('selected'); });
        updateBtns();
    });
    document.getElementById('deselectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.proj-check').forEach(function(cb) { cb.checked = false; cb.closest('.project-card').classList.remove('selected'); });
        updateBtns();
    });

    function getCostDevMap(sheetName, kickoff, launch) {
        if (!sheetName || !workbook) return null;
        var ws = workbook.Sheets[sheetName];
        if (!ws) return null;
        var sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
        if (sheet.length < 38) return null;
        var row2 = sheet[1] || [], row38 = sheet[37] || [];
        var map = {};
        for (var c = 0; c < row2.length; c++) {
            var cell = row2[c]; if (cell === null || cell === undefined) continue;
            var ym = null;
            if (typeof cell === 'number' && cell > 30000 && cell < 60000) { ym = excelDateToYM(cell); }
            else if (typeof cell === 'string') { var m = cell.match(/(\d{4})[\-\/](\d{1,2})/); if (m) ym = m[1] + '-' + ('0' + m[2]).slice(-2); }
            if (!ym) continue;
            if (ym >= kickoff && ym <= launch) { map[ym] = (row38[c] !== null && row38[c] !== undefined) ? row38[c] : 0; }
        }
        return map;
    }

    function getBreakdownMap(sheetName, kickoff, launch) {
        if (!sheetName || !workbook) return null;
        var ws = workbook.Sheets[sheetName];
        if (!ws) return null;
        var sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
        if (sheet.length < 64) return null;
        var row2=sheet[1]||[], rLbr=sheet[38]||[], rMkt=sheet[44]||[], rOut=sheet[46]||[], rDep=sheet[52]||[], rSrv=sheet[58]||[], rOth=sheet[63]||[];
        var bdMap = {};
        for (var c = 0; c < row2.length; c++) {
            var cell = row2[c]; if (cell===null||cell===undefined) continue;
            var ym = null;
            if (typeof cell==='number' && cell>30000 && cell<60000) { ym=excelDateToYM(cell); }
            else if (typeof cell==='string') { var m2=cell.match(/(\d{4})[\-\/](\d{1,2})/); if(m2) ym=m2[1]+'-'+('0'+m2[2]).slice(-2); }
            if (!ym) continue;
            if (ym>=kickoff && ym<=launch) {
                bdMap[ym] = { labor:(rLbr[c]!=null)?rLbr[c]:0, marketing:(rMkt[c]!=null)?rMkt[c]:0, outsourcing:(rOut[c]!=null)?rOut[c]:0, depreciation:(rDep[c]!=null)?rDep[c]:0, server:(rSrv[c]!=null)?rSrv[c]:0, other:(rOth[c]!=null)?rOth[c]:0 };
            }
        }
        return bdMap;
    }

    function collectSelectedData() {
        var cards = document.querySelectorAll('.project-card');
        var saveData = {}, warnings = [];
        cards.forEach(function(card) {
            var cb = card.querySelector('.proj-check');
            if (!cb.checked) return;
            var name=card.getAttribute('data-name'), kickoff=card.querySelector('.dt-kickoff').value, current=card.querySelector('.dt-current').value, launch=card.querySelector('.dt-launch').value, sheetName=card.querySelector('.dt-sheet').value.trim();
            var proj = parsedProjects[name];
            if (!proj) return;
            var costDevMap=null, breakdownMap=null;
            if (sheetName) {
                costDevMap = getCostDevMap(sheetName, kickoff, launch);
                if (!costDevMap) warnings.push('âš ï¸ [' + name + '] ì‹œíŠ¸ "' + sheetName + '" ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ costDev ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                breakdownMap = getBreakdownMap(sheetName, kickoff, launch);
            }
            var cumCostDev = 0;
            var filtered = proj.rows.filter(function(r){ return r.date>=kickoff && r.date<=launch; }).map(function(r) {
                var costDev;
                if (costDevMap) { var monthly=(costDevMap[r.date]!==undefined)?costDevMap[r.date]:0; cumCostDev+=monthly; costDev=cumCostDev; }
                else { costDev=r.costDev; }
                return { date:r.date, mmDev:r.mmDev, mmBiz:r.mmBiz, mmTotal:r.mmTotal, costDev:costDev, costBiz:r.costBiz, costTotal:r.costTotal, costGI:costDev+r.costBiz, costBreakdown:breakdownMap?(breakdownMap[r.date]||{labor:0,marketing:0,outsourcing:0,depreciation:0,server:0,other:0}):null };
            });
            saveData[name] = { kickoff:kickoff, current:current, launch:launch, rows:filtered };
        });
        return { data: saveData, warnings: warnings };
    }

    document.getElementById('downloadBtn').addEventListener('click', function() {
        var result = collectSelectedData();
        lastSaveData = result.data;
        var jsonStr = JSON.stringify(lastSaveData, null, 2);
        var blob = new Blob([jsonStr], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href=url; a.download='projects.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        var sizeKB=(blob.size/1024).toFixed(1), cnt=Object.keys(lastSaveData).length;
        var msgHtml = '<div class="msg msg-success">âœ… projects.json ë‹¤ìš´ë¡œë“œ ì™„ë£Œ ('+cnt+'ê°œ í”„ë¡œì íŠ¸, '+sizeKB+' KB)</div>'
            + '<div class="msg msg-warn" style="margin-top:8px;">ğŸ“Œ ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ GitHub ë ˆí¬ì˜ <strong>data/</strong> í´ë”ì— ë„£ê³  push í•´ì£¼ì„¸ìš”.</div>';
        if (result.warnings.length > 0) msgHtml += '<div class="msg msg-error" style="margin-top:8px;">'+result.warnings.join('<br>')+'</div>';
        document.getElementById('save-msg').innerHTML = msgHtml;
    });

    document.getElementById('generateUrlBtn').addEventListener('click', function() {
        var baseUrl = getBaseUrl();
        if (!baseUrl) { alert('GitHub ê³„ì •ëª…ê³¼ ë ˆí¬ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }
        var result = collectSelectedData();
        var data = result.data, names = Object.keys(data);
        var urlHTML = '<h3 style="margin-top:20px; margin-bottom:12px;">ğŸ“‹ ë…¸ì…˜ ì„ë² ë“œìš© URL ('+names.length+'ê°œ)</h3>';
        names.forEach(function(name) {
            var enc=encodeURIComponent(name);
            var urls = [
                ['í‘œ',        baseUrl+'/view.html?project='+enc+'&type=table'],
                ['MM',        baseUrl+'/view.html?project='+enc+'&type=chart'],
                ['ë¹„ìš©',      baseUrl+'/view.html?project='+enc+'&type=cost'],
                ['ë§‰ëŒ€',      baseUrl+'/view.html?project='+enc+'&type=bar'],
                ['íŒŒì´(ê¸°ì¤€)',baseUrl+'/view.html?project='+enc+'&type=pie'],
                ['íŒŒì´(ì „ë‹¬)',baseUrl+'/view.html?project='+enc+'&type=pie&month=prev'],
                ['ëŒ€ì‹œë³´ë“œ',  baseUrl+'/view.html?project='+enc+'&type=dashboard']
            ];
            urlHTML += '<div class="url-group"><h4>ğŸ“Œ '+name+'</h4>';
            urls.forEach(function(u) {
                urlHTML += '<div class="url-row"><span style="font-size:12px;color:#888;min-width:55px;">'+u[0]+'</span><code>'+u[1]+'</code><button class="copy-btn" data-url="'+u[1]+'">ë³µì‚¬</button></div>';
            });
            urlHTML += '</div>';
        });
        document.getElementById('url-output').innerHTML = urlHTML;
        document.querySelectorAll('.copy-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var self=this;
                navigator.clipboard.writeText(self.getAttribute('data-url')).then(function() {
                    self.textContent='âœ“ ë³µì‚¬ë¨'; setTimeout(function(){self.textContent='ë³µì‚¬';},1500);
                });
            });
        });
    });

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // STEP 4: ì°¨íŠ¸ ì„¤ì • & ë¯¸ë¦¬ë³´ê¸°
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var DEFAULT_SETTINGS = {
        series: {
            mmDev:            { color: '#3780bf', opacity: 0.6 },
            mmBiz:            { color: '#db4052', opacity: 0.6 },
            costDev:          { color: '#3780bf', opacity: 0.6 },
            costBiz:          { color: '#db4052', opacity: 0.6 },
            bar_labor:        { color: '#3780bf', opacity: 1.0 },
            bar_marketing:    { color: '#f39c12', opacity: 1.0 },
            bar_outsourcing:  { color: '#27ae60', opacity: 1.0 },
            bar_depreciation: { color: '#8e44ad', opacity: 1.0 },
            bar_server:       { color: '#16a085', opacity: 1.0 },
            bar_other:        { color: '#7f8c8d', opacity: 1.0 }
        },
        axes: {
            chart_y_auto: true, chart_y_max: '', chart_y_step: '',
            cost_y_auto:  true, cost_y_max:  '', cost_y_step:  '',
            bar_y_auto:   true, bar_y_max:   '', bar_y_step:   '',
            x_format: 'YYYY-MM'
        }
    };
    var currentSettings = JSON.parse(JSON.stringify(DEFAULT_SETTINGS));

    var SERIES_DEFS = [
        { group: 'MM ì°¨íŠ¸' },
        { key: 'mmDev',            label: 'ê°œë°œ MM'     },
        { key: 'mmBiz',            label: 'ì‚¬ì—… MM'     },
        { group: 'ëˆ„ì  ê°œë°œë¹„ ì°¨íŠ¸' },
        { key: 'costDev',          label: 'ê°œë°œë¹„'      },
        { key: 'costBiz',          label: 'ì‚¬ì—…ë¹„'      },
        { group: 'ë§‰ëŒ€ / íŒŒì´ ì°¨íŠ¸' },
        { key: 'bar_labor',        label: 'ì¸ê±´ë¹„'      },
        { key: 'bar_marketing',    label: 'ë§ˆì¼€íŒ…ë¹„'    },
        { key: 'bar_outsourcing',  label: 'ì™¸ì£¼ë¹„'      },
        { key: 'bar_depreciation', label: 'ê°ê°€ìƒê°ë¹„'  },
        { key: 'bar_server',       label: 'ì„œë²„ë¹„'      },
        { key: 'bar_other',        label: 'ê¸°íƒ€ ìš´ì˜ë¹„' }
    ];

    function renderSeriesTable() {
        var tbody = document.querySelector('#series-table tbody');
        var html = '';
        SERIES_DEFS.forEach(function(def) {
            if (def.group) {
                html += '<tr class="group-hd"><td colspan="4">' + def.group + '</td></tr>';
            } else {
                var s = currentSettings.series[def.key];
                html += '<tr>'
                    + '<td>' + def.label + '</td>'
                    + '<td><input type="color" class="s-color" data-key="' + def.key + '" value="' + s.color + '"></td>'
                    + '<td><input type="range" class="op-slider" data-key="' + def.key + '" min="0" max="1" step="0.05" value="' + s.opacity + '"></td>'
                    + '<td><span class="oval" id="oval-' + def.key + '">' + s.opacity.toFixed(2) + '</span></td>'
                    + '</tr>';
            }
        });
        tbody.innerHTML = html;
        tbody.querySelectorAll('.s-color').forEach(function(el) {
            el.addEventListener('input', function() {
                currentSettings.series[this.dataset.key].color = this.value;
                renderPreview();
            });
        });
        tbody.querySelectorAll('.op-slider').forEach(function(el) {
            el.addEventListener('input', function() {
                var v = parseFloat(this.value);
                currentSettings.series[this.dataset.key].opacity = v;
                document.getElementById('oval-' + this.dataset.key).textContent = v.toFixed(2);
                renderPreview();
            });
        });
    }

    function renderAxisSettings() {
        var container = document.getElementById('axis-settings');
        var axes = [
            { prefix: 'chart', label: 'MM ì°¨íŠ¸ Yì¶•' },
            { prefix: 'cost',  label: 'ëˆ„ì  ê°œë°œë¹„ Yì¶•' },
            { prefix: 'bar',   label: 'ë§‰ëŒ€ ì°¨íŠ¸ Yì¶•' }
        ];
        var html = '';
        axes.forEach(function(a) {
            var ax = currentSettings.axes;
            var isAuto = ax[a.prefix + '_y_auto'];
            html += '<div class="axis-block">'
                + '<div class="axis-block-title">' + a.label + '</div>'
                + '<div class="axis-row2"><label><input type="checkbox" class="ax-auto" data-prefix="' + a.prefix + '" ' + (isAuto ? 'checked' : '') + '> ìë™ ë²”ìœ„</label></div>'
                + '<div class="ax-manual" id="ax-man-' + a.prefix + '" style="' + (isAuto ? 'display:none;' : '') + '">'
                + '<div class="axis-row2"><label>ìµœëŒ“ê°’</label><input type="number" class="ax-max" data-prefix="' + a.prefix + '" value="' + ax[a.prefix+'_y_max'] + '" placeholder="ìë™"></div>'
                + '<div class="axis-row2"><label>ìŠ¤í…</label><input type="number" class="ax-step" data-prefix="' + a.prefix + '" value="' + ax[a.prefix+'_y_step'] + '" placeholder="ìë™"></div>'
                + '</div></div>';
        });
        container.innerHTML = html;
        container.querySelectorAll('.ax-auto').forEach(function(el) {
            el.addEventListener('change', function() {
                currentSettings.axes[this.dataset.prefix + '_y_auto'] = this.checked;
                document.getElementById('ax-man-' + this.dataset.prefix).style.display = this.checked ? 'none' : '';
                renderPreview();
            });
        });
        container.querySelectorAll('.ax-max').forEach(function(el) {
            el.addEventListener('input', function() { currentSettings.axes[this.dataset.prefix + '_y_max'] = this.value; renderPreview(); });
        });
        container.querySelectorAll('.ax-step').forEach(function(el) {
            el.addEventListener('input', function() { currentSettings.axes[this.dataset.prefix + '_y_step'] = this.value; renderPreview(); });
        });
    }

    function renderXFmt() {
        var container = document.getElementById('xfmt-row');
        var formats = ['YYYY-MM', 'YY.MM', 'YYë…„MMì›”'];
        container.innerHTML = formats.map(function(f) {
            return '<label><input type="radio" name="xformat" value="' + f + '" ' + (currentSettings.axes.x_format === f ? 'checked' : '') + '> ' + f + '</label>';
        }).join('');
        container.querySelectorAll('input[name="xformat"]').forEach(function(el) {
            el.addEventListener('change', function() { currentSettings.axes.x_format = this.value; });
        });
    }

    // â”€â”€ Chart.js ë¯¸ë¦¬ë³´ê¸° â”€â”€
    function h2r(hex) {
        hex = hex.replace('#','');
        if (hex.length===3) hex=hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
        return { r:parseInt(hex.slice(0,2),16), g:parseInt(hex.slice(2,4),16), b:parseInt(hex.slice(4,6),16) };
    }
    function toRgba(hex, opacity) { var c=h2r(hex); return 'rgba('+c.r+','+c.g+','+c.b+','+opacity+')'; }
    function toRgbStr(hex) { var c=h2r(hex); return 'rgb('+c.r+','+c.g+','+c.b+')'; }

    var SLABELS = ['2024-01','2024-02','2024-03','2024-04','2024-05','2024-06','2024-07','2024-08'];
    var SD1 = [5,8,12,10,14,11,9,13], SD2 = [2,3,4,3,5,4,3,4];
    var SBAR = [[800,900,950,1000,1050,980,1020,1100],[200,250,200,300,250,200,280,300],[100,120,110,130,100,90,120,110],[50,60,50,60,55,50,60,65],[80,90,85,95,90,80,90,100],[50,40,60,50,55,60,45,55]];
    var SPIE = [1100,300,110,60,90,55];
    var BAR_KEYS  = ['bar_labor','bar_marketing','bar_outsourcing','bar_depreciation','bar_server','bar_other'];
    var BAR_NAMES = ['ì¸ê±´ë¹„','ë§ˆì¼€íŒ…ë¹„','ì™¸ì£¼ë¹„','ê°ê°€ìƒê°ë¹„','ì„œë²„ë¹„','ê¸°íƒ€ ìš´ì˜ë¹„'];
    var previewInst = null, previewType = 'mm';

    function renderPreview() {
        var canvas = document.getElementById('previewChart');
        if (!canvas) return;
        if (previewInst) { previewInst.destroy(); previewInst = null; }
        var ctx = canvas.getContext('2d');
        var s = currentSettings.series, ax = currentSettings.axes;
        if (previewType === 'mm' || previewType === 'cost') {
            var k1 = previewType==='mm' ? 'mmDev' : 'costDev';
            var k2 = previewType==='mm' ? 'mmBiz' : 'costBiz';
            var l1 = previewType==='mm' ? 'ê°œë°œ MM' : 'ê°œë°œë¹„';
            var l2 = previewType==='mm' ? 'ì‚¬ì—… MM' : 'ì‚¬ì—…ë¹„';
            var pfx = previewType==='mm' ? 'chart' : 'cost';
            var yOpts = { beginAtZero: true };
            if (!ax[pfx+'_y_auto'] && ax[pfx+'_y_max']) yOpts.max = parseFloat(ax[pfx+'_y_max']);
            if (!ax[pfx+'_y_auto'] && ax[pfx+'_y_step']) yOpts.ticks = { stepSize: parseFloat(ax[pfx+'_y_step']) };
            previewInst = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: SLABELS,
                    datasets: [
                        { label: l1, data: SD1.map(function(v,i){return v+SD2[i];}), backgroundColor: toRgba(s[k1].color, s[k1].opacity), borderColor: toRgbStr(s[k1].color), fill: true, tension: 0.1 },
                        { label: l2, data: SD2, backgroundColor: toRgba(s[k2].color, s[k2].opacity), borderColor: toRgbStr(s[k2].color), fill: true, tension: 0.1 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { y: yOpts, x: { ticks: { maxRotation: 45 } } } }
            });
        } else if (previewType === 'bar') {
            var byOpts = { stacked: true, beginAtZero: true };
            if (!ax.bar_y_auto && ax.bar_y_max) byOpts.max = parseFloat(ax.bar_y_max);
            if (!ax.bar_y_auto && ax.bar_y_step) byOpts.ticks = { stepSize: parseFloat(ax.bar_y_step) };
            previewInst = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: SLABELS,
                    datasets: BAR_KEYS.map(function(k,i) {
                        return { label: BAR_NAMES[i], data: SBAR[i], backgroundColor: toRgba(s[k].color, s[k].opacity), borderColor: toRgbStr(s[k].color), borderWidth: 0 };
                    })
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: byOpts } }
            });
        } else if (previewType === 'pie') {
            previewInst = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: BAR_NAMES,
                    datasets: [{ data: SPIE, backgroundColor: BAR_KEYS.map(function(k){ return toRgba(s[k].color, s[k].opacity); }), borderColor: BAR_KEYS.map(function(k){ return toRgbStr(s[k].color); }), borderWidth: 1 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });
        }
    }

    renderSeriesTable();
    renderAxisSettings();
    renderXFmt();
    renderPreview();

    document.querySelectorAll('.preview-tab').forEach(function(tab) {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.preview-tab').forEach(function(t){ t.classList.remove('active'); });
            this.classList.add('active');
            previewType = this.dataset.type;
            renderPreview();
        });
    });

    document.getElementById('downloadSettingsBtn').addEventListener('click', function() {
        var jsonStr = JSON.stringify(currentSettings, null, 2);
        var blob = new Blob([jsonStr], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href=url; a.download='settings.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        document.getElementById('settings-msg').innerHTML = '<div class="msg msg-success">âœ… settings.json ë‹¤ìš´ë¡œë“œ ì™„ë£Œ â€” GitHub ë ˆí¬ì˜ <strong>data/</strong> í´ë”ì— ë„£ê³  push í•´ì£¼ì„¸ìš”.</div>';
    });

}); // end DOMContentLoaded
</script>
</body>
</html>
