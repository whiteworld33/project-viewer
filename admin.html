<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ë°ì´í„° ê´€ë¦¬ì</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        h1 { text-align: center; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 24px; font-size: 14px; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 1100px; margin: 0 auto; }
        .section { margin-bottom: 24px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #eee; }
        .section-title .badge { font-size: 12px; background: #e0e0e0; color: #555; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 400; }

        .file-area { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .file-area input[type="file"] { font-size: 14px; }
        .file-area .status { font-size: 13px; color: #888; }

        #project-list { display: flex; flex-direction: column; gap: 10px; }
        .project-card { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa; flex-wrap: wrap; }
        .project-card.selected { border-color: #007bff; background: #f0f7ff; }
        .project-card input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
        .project-card .name { font-weight: 500; min-width: 150px; font-size: 14px; }
        .project-card .dates { display: flex; gap: 6px; font-size: 12px; flex-wrap: wrap; align-items: center; }
        .project-card .dates label { color: #666; }
        .project-card .dates input[type="month"] { font-size: 12px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; width: 120px; }
        .project-card .sheet-wrap { display: flex; align-items: center; gap: 4px; font-size: 12px; }
        .project-card .sheet-wrap label { color: #666; white-space: nowrap; }
        .project-card .sheet-wrap input[type="text"] { font-size: 12px; padding: 2px 6px; border: 1px solid #ccc; border-radius: 3px; width: 160px; background: #fffbe6; }
        .sheet-hint { font-size: 11px; color: #aaa; margin-top: 2px; }

        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn { font-size: 15px; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #545b62; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        #url-output { margin-top: 20px; }
        .url-group { margin-bottom: 16px; }
        .url-group h4 { margin-bottom: 6px; color: #333; }
        .url-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .url-row code { flex: 1; background: #f5f5f5; padding: 8px 12px; border-radius: 4px; font-size: 13px; word-break: break-all; border: 1px solid #e0e0e0; }
        .url-row .copy-btn { font-size: 12px; padding: 6px 12px; background: #17a2b8; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .url-row .copy-btn:hover { background: #138496; }

        .msg { padding: 10px 16px; border-radius: 6px; margin-top: 12px; font-size: 14px; }
        .msg-success { background: #d4edda; color: #155724; }
        .msg-info { background: #d1ecf1; color: #0c5460; }
        .msg-warn { background: #fff3cd; color: #856404; }
        .msg-error { background: #f8d7da; color: #721c24; }

        #storage-info { font-size: 13px; color: #888; text-align: center; margin-top: 10px; }

        .github-url-input { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
        .github-url-input label { font-weight: 500; font-size: 14px; white-space: nowrap; }
        .github-url-input input { font-size: 14px; padding: 8px 12px; border: 1px solid #ccc; border-radius: 4px; width: 200px; }
        .github-url-preview { font-size: 12px; color: #555; background: #f0f7ff; border: 1px solid #b8d9f8; border-radius: 4px; padding: 6px 10px; margin-bottom: 12px; word-break: break-all; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š í”„ë¡œì íŠ¸ ë°ì´í„° ê´€ë¦¬ì</h1>
    <p class="subtitle">ì—‘ì…€ â†’ projects.json ë‹¤ìš´ë¡œë“œ â†’ GitHub Pages â†’ ë…¸ì…˜ ì„ë² ë“œ</p>

    <!-- STEP 1: íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="section">
        <div class="section-title">1ï¸âƒ£ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</div>
        <div class="file-area">
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <span class="status" id="file-status">íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</span>
        </div>
    </div>

    <!-- STEP 2: í”„ë¡œì íŠ¸ ì„ íƒ -->
    <div class="section">
        <div class="section-title">2ï¸âƒ£ í”„ë¡œì íŠ¸ ì„ íƒ ë° ê¸°ê°„ ì„¤ì • <span class="badge" id="project-count">0ê°œ íƒì§€</span></div>
        <p style="font-size:12px; color:#888; margin-bottom:8px;">ğŸ’¡ <strong>ë¹„ìš© ì‹œíŠ¸ëª…</strong>: costDev ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ì‹œíŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”. ë¹„ì›Œë‘ë©´ ê¸°ì¡´ ì‹œíŠ¸ ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        <div id="project-list">
            <p style="color:#aaa; font-size:14px;">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ í”„ë¡œì íŠ¸ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        <div class="btn-group" style="justify-content:flex-start; margin-top:10px;">
            <button class="btn btn-secondary" id="selectAllBtn" style="font-size:13px; padding:6px 14px;" disabled>ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" id="deselectAllBtn" style="font-size:13px; padding:6px 14px;" disabled>ì „ì²´ í•´ì œ</button>
        </div>
    </div>

    <!-- STEP 3: JSON ë‹¤ìš´ë¡œë“œ & URL ìƒì„± -->
    <div class="section">
        <div class="section-title">3ï¸âƒ£ JSON ë‹¤ìš´ë¡œë“œ ë° ì„ë² ë“œ URL ìƒì„±</div>
        <div class="github-url-input">
            <label>GitHub ê³„ì •ëª…:</label>
            <input type="text" id="accountInput" placeholder="ì˜ˆ: whiteworld33">
            <label style="margin-left:8px;">ë ˆí¬ëª…:</label>
            <input type="text" id="repoInput" placeholder="ì˜ˆ: project-viewer">
        </div>
        <div class="github-url-preview" id="urlPreview">ğŸ”— ìƒì„±ë  ê¸°ë³¸ URL: <strong>ê³„ì •ëª…ê³¼ ë ˆí¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</strong></div>
        <div class="btn-group">
            <button class="btn btn-success" id="downloadBtn" disabled>ğŸ“¥ projects.json ë‹¤ìš´ë¡œë“œ</button>
            <button class="btn btn-primary" id="generateUrlBtn" disabled>ğŸ”— ì„ë² ë“œ URL ìƒì„±</button>
        </div>
        <div id="save-msg"></div>
        <div id="storage-info"></div>
        <div id="url-output"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    function excelDateToYM(serial) {
        if (typeof serial !== 'number') return null;
        if (serial > 59) serial -= 1;
        var d = new Date((serial - 25568) * 86400 * 1000);
        return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2);
    }

    var parsedProjects = {};
    var workbook = null; // ì „ì—­ workbook ì°¸ì¡° (ë¹„ìš© ì‹œíŠ¸ íŒŒì‹±ìš©)
    var lastSaveData = null;

    // â”€â”€ STEP 1: íŒŒì¼ ì—…ë¡œë“œ â”€â”€
    document.getElementById('fileInput').addEventListener('change', function() {
        var file = this.files[0];
        if (!file) return;
        document.getElementById('file-status').textContent = 'íŒŒì‹± ì¤‘...';

        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = new Uint8Array(e.target.result);
                workbook = XLSX.read(data, { type: 'array' }); // ì „ì—­ ì €ì¥
                var sheetName = 'ê°œë°œì „ëµê¸°íšì‹¤';
                var ws = workbook.Sheets[sheetName];
                if (!ws) throw new Error("'" + sheetName + "' ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                var sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
                parsedProjects = {};

                for (var i = 0; i < sheet.length; i++) {
                    for (var j = 0; j < (sheet[i] || []).length; j++) {
                        var cellVal = (sheet[i][j] || '').toString().trim();
                        if (!cellVal || typeof sheet[i][j] === 'number') continue;

                        var dataRow = i + 5;
                        if (dataRow >= sheet.length) continue;
                        var checkVal = (sheet[dataRow] || [])[j];
                        if (typeof checkVal !== 'number' || checkVal < 30000 || checkVal > 60000) continue;

                        var rows = [];
                        for (var r = dataRow; r < sheet.length; r++) {
                            var rv = (sheet[r] || [])[j];
                            if (rv === null || typeof rv !== 'number') break;
                            var ym = excelDateToYM(rv);
                            if (!ym) break;
                            var row = sheet[r] || [];
                            rows.push({
                                date: ym,
                                mmDev:    row[j + 1] || 0,
                                mmBiz:    row[j + 2] || 0,
                                mmTotal:  row[j + 3] || 0,
                                costDev:  row[j + 4] || 0,
                                costBiz:  row[j + 5] || 0,
                                costTotal: row[j + 6] || 0
                                // costGIëŠ” ë‹¤ìš´ë¡œë“œ ì‹œ costDev+costBizë¡œ ê³„ì‚°
                            });
                        }
                        if (rows.length > 0) {
                            parsedProjects[cellVal] = {
                                rows: rows,
                                firstDate: rows[0].date,
                                lastDate: rows[rows.length - 1].date
                            };
                        }
                    }
                }

                var names = Object.keys(parsedProjects);
                document.getElementById('file-status').textContent = file.name + ' (' + names.length + 'ê°œ í”„ë¡œì íŠ¸ íƒì§€)';
                document.getElementById('project-count').textContent = names.length + 'ê°œ íƒì§€';
                renderProjectList(names);

            } catch(err) {
                document.getElementById('file-status').textContent = 'ì˜¤ë¥˜: ' + err.message;
                document.getElementById('project-list').innerHTML = '<p style="color:red;">' + err.message + '</p>';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // â”€â”€ í”„ë¡œì íŠ¸ ëª©ë¡ ë Œë”ë§ â”€â”€
    function renderProjectList(names) {
        var container = document.getElementById('project-list');
        if (names.length === 0) {
            container.innerHTML = '<p style="color:#aaa;">íƒì§€ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        var now = new Date();
        var currentYM = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2);

        container.innerHTML = names.map(function(name) {
            var p = parsedProjects[name];
            return '<div class="project-card" data-name="' + name + '">'
                + '<input type="checkbox" class="proj-check">'
                + '<span class="name">' + name + '</span>'
                + '<a class="gh-link" href="#" target="_blank" style="font-size:12px;color:#007bff;text-decoration:none;margin-left:6px;display:none;">ğŸ”— ë³´ê¸°</a>'
                + '<div class="dates">'
                + '<div><label>í‚¥ì˜¤í”„</label><input type="month" class="dt-kickoff" value="' + p.firstDate + '"></div>'
                + '<div><label>ê¸°ì¤€ì›”</label><input type="month" class="dt-current" value="' + currentYM + '"></div>'
                + '<div><label>ëŸ°ì¹­</label><input type="month" class="dt-launch" value="' + p.lastDate + '"></div>'
                + '</div>'
                + '<div class="sheet-wrap">'
                + '<label>ë¹„ìš© ì‹œíŠ¸ëª…</label>'
                + '<input type="text" class="dt-sheet" placeholder="ì‹œíŠ¸ëª… ì…ë ¥">'
                + '</div>'
                + '</div>';
        }).join('');

        container.querySelectorAll('.project-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
                var cb = card.querySelector('.proj-check');
                cb.checked = !cb.checked;
                card.classList.toggle('selected', cb.checked);
                updateBtns();
            });
            card.querySelector('.proj-check').addEventListener('change', function() {
                card.classList.toggle('selected', this.checked);
                updateBtns();
            });
        });

        document.getElementById('selectAllBtn').disabled = false;
        document.getElementById('deselectAllBtn').disabled = false;
        updateBtns();
        updateProjectLinks();
    }

    function updateBtns() {
        var checked = document.querySelectorAll('.proj-check:checked').length;
        document.getElementById('downloadBtn').disabled = (checked === 0);
        document.getElementById('generateUrlBtn').disabled = (checked === 0);
    }

    function getBaseUrl() {
        var account = document.getElementById('accountInput').value.trim().replace(/\/+$/, '');
        var repo    = document.getElementById('repoInput').value.trim().replace(/\/+$/, '');
        if (!account || !repo) return '';
        return 'https://' + account + '.github.io/' + repo;
    }
    function updateUrlPreview() {
        var base = getBaseUrl();
        var preview = document.getElementById('urlPreview');
        if (base) {
            preview.innerHTML = 'ğŸ”— ìƒì„±ë  ê¸°ë³¸ URL: <strong>' + base + '</strong>';
        } else {
            preview.innerHTML = 'ğŸ”— ìƒì„±ë  ê¸°ë³¸ URL: <strong>ê³„ì •ëª…ê³¼ ë ˆí¬ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”</strong>';
        }
    }
    function updateProjectLinks() {
        var base = getBaseUrl();
        document.querySelectorAll('.project-card').forEach(function(card) {
            var name = card.getAttribute('data-name');
            var link = card.querySelector('.gh-link');
            if (!link) return;
            if (base && name) {
                var url = base + '/view.html?project=' + encodeURIComponent(name) + '&type=dashboard';
                link.href = url;
                link.style.display = 'inline';
            } else {
                link.href = '#';
                link.style.display = 'none';
            }
        });
        updateUrlPreview();
    }
    document.getElementById('accountInput').addEventListener('input', updateProjectLinks);
    document.getElementById('repoInput').addEventListener('input', updateProjectLinks);
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.proj-check').forEach(function(cb) { cb.checked = true; cb.closest('.project-card').classList.add('selected'); });
        updateBtns();
    });
    document.getElementById('deselectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.proj-check').forEach(function(cb) { cb.checked = false; cb.closest('.project-card').classList.remove('selected'); });
        updateBtns();
    });

    // â”€â”€ costDev ì‹œíŠ¸ íŒŒì‹± â”€â”€
    // ì§€ì • ì‹œíŠ¸ì˜ 2í–‰(index 1)ì—ì„œ ë‚ ì§œ ìŠ¤ìº” â†’ í‚¥ì˜¤í”„~ëŸ°ì¹­ ë²”ìœ„ â†’ 38í–‰(index 37) ê°’ ìˆ˜ì§‘
    function getCostDevMap(sheetName, kickoff, launch) {
        if (!sheetName || !workbook) return null;
        var ws = workbook.Sheets[sheetName];
        if (!ws) return null;

        var sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
        if (sheet.length < 38) return null;

        var row2  = sheet[1]  || []; // 2í–‰: ë‚ ì§œ í—¤ë”
        var row38 = sheet[37] || []; // 38í–‰: costDev ë°ì´í„°

        var map = {};
        for (var c = 0; c < row2.length; c++) {
            var cell = row2[c];
            if (cell === null || cell === undefined) continue;
            var ym = null;
            if (typeof cell === 'number' && cell > 30000 && cell < 60000) {
                ym = excelDateToYM(cell);
            } else if (typeof cell === 'string') {
                // "YYYY-MM" ë˜ëŠ” "YYYY/MM" í˜•íƒœ ëŒ€ì‘
                var m = cell.match(/(\d{4})[\-\/](\d{1,2})/);
                if (m) ym = m[1] + '-' + ('0' + m[2]).slice(-2);
            }
            if (!ym) continue;
            if (ym >= kickoff && ym <= launch) {
                map[ym] = (row38[c] !== null && row38[c] !== undefined) ? row38[c] : 0;
            }
        }
        return map;
    }

    // â”€â”€ í•­ëª©ë³„ ì›”ë³„ ë¹„ìš© ë§µ (bar ì°¨íŠ¸ìš©) â”€â”€
    // í–‰ ì¸ë±ìŠ¤(0-based): ì¸ê±´ë¹„=38, ë§ˆì¼€íŒ…ë¹„=44, ì™¸ì£¼ë¹„=46, ê°ê°€ìƒê°ë¹„=52, ì„œë²„ë¹„=58, ê¸°íƒ€ìš´ì˜ë¹„=63
    function getBreakdownMap(sheetName, kickoff, launch) {
        if (!sheetName || !workbook) return null;
        var ws = workbook.Sheets[sheetName];
        if (!ws) return null;
        var sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
        if (sheet.length < 64) return null;
        var row2  = sheet[1]  || [];
        var rLbr  = sheet[38] || [];
        var rMkt  = sheet[44] || [];
        var rOut  = sheet[46] || [];
        var rDep  = sheet[52] || [];
        var rSrv  = sheet[58] || [];
        var rOth  = sheet[63] || [];
        var bdMap = {};
        for (var c = 0; c < row2.length; c++) {
            var cell = row2[c];
            if (cell === null || cell === undefined) continue;
            var ym = null;
            if (typeof cell === 'number' && cell > 30000 && cell < 60000) {
                ym = excelDateToYM(cell);
            } else if (typeof cell === 'string') {
                var m2 = cell.match(/(\d{4})[\-\/](\d{1,2})/);
                if (m2) ym = m2[1] + '-' + ('0' + m2[2]).slice(-2);
            }
            if (!ym) continue;
            if (ym >= kickoff && ym <= launch) {
                bdMap[ym] = {
                    labor:        (rLbr[c] != null) ? rLbr[c] : 0,
                    marketing:    (rMkt[c] != null) ? rMkt[c] : 0,
                    outsourcing:  (rOut[c] != null) ? rOut[c] : 0,
                    depreciation: (rDep[c] != null) ? rDep[c] : 0,
                    server:       (rSrv[c] != null) ? rSrv[c] : 0,
                    other:        (rOth[c] != null) ? rOth[c] : 0
                };
            }
        }
        return bdMap;
    }
    // â”€â”€ ì„ íƒ ë°ì´í„° ìˆ˜ì§‘ â”€â”€
    function collectSelectedData() {
        var cards = document.querySelectorAll('.project-card');
        var saveData = {};
        var warnings = [];

        cards.forEach(function(card) {
            var cb = card.querySelector('.proj-check');
            if (!cb.checked) return;
            var name      = card.getAttribute('data-name');
            var kickoff   = card.querySelector('.dt-kickoff').value;
            var current   = card.querySelector('.dt-current').value;
            var launch    = card.querySelector('.dt-launch').value;
            var sheetName = card.querySelector('.dt-sheet').value.trim();
            var proj      = parsedProjects[name];
            if (!proj) return;

            // costDev ë§µ ê°€ì ¸ì˜¤ê¸° (ì‹œíŠ¸ëª… ìˆì„ ë•Œë§Œ)
            var costDevMap = null;
            var breakdownMap = null;
            if (sheetName) {
                costDevMap = getCostDevMap(sheetName, kickoff, launch);
                if (!costDevMap) {
                    warnings.push('âš ï¸ [' + name + '] ì‹œíŠ¸ "' + sheetName + '" ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ì¡´ costDev ê°’ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.');
                }
                breakdownMap = getBreakdownMap(sheetName, kickoff, launch);
            }

            // ë¹„ìš© ì‹œíŠ¸ ì‚¬ìš© ì‹œ: ì›”ë³„ ê°’ì„ ëˆ„ì í•©ìœ¼ë¡œ ë³€í™˜
            var cumCostDev = 0;
            var filtered = proj.rows
                .filter(function(r) { return r.date >= kickoff && r.date <= launch; })
                .map(function(r) {
                    var costDev;
                    if (costDevMap) {
                        // ë¹„ìš© ì‹œíŠ¸ ì§€ì •ë¨: ì›”ë³„ ê°’ì„ ëˆ„ì 
                        var monthly = (costDevMap[r.date] !== undefined) ? costDevMap[r.date] : 0;
                        cumCostDev += monthly;
                        costDev = cumCostDev;
                    } else {
                        // ë¹„ìš© ì‹œíŠ¸ ë¯¸ì§€ì •: ê¸°ì¡´ ì‹œíŠ¸ ê°’ ê·¸ëŒ€ë¡œ (ì´ë¯¸ ëˆ„ì ê°’)
                        costDev = r.costDev;
                    }
                    return {
                        date:      r.date,
                        mmDev:     r.mmDev,
                        mmBiz:     r.mmBiz,
                        mmTotal:   r.mmTotal,
                        costDev:   costDev,
                        costBiz:   r.costBiz,
                        costTotal: r.costTotal,
                        costGI:        costDev + r.costBiz,  // ëˆ„ì  costDev + costBiz
                        costBreakdown: breakdownMap ? (breakdownMap[r.date] || {labor:0,marketing:0,outsourcing:0,depreciation:0,server:0,other:0}) : null
                    };
                });

            saveData[name] = {
                kickoff: kickoff,
                current: current,
                launch:  launch,
                rows:    filtered
            };
        });
        return { data: saveData, warnings: warnings };
    }

    // â”€â”€ JSON ë‹¤ìš´ë¡œë“œ â”€â”€
    document.getElementById('downloadBtn').addEventListener('click', function() {
        var result = collectSelectedData();
        lastSaveData = result.data;

        var jsonStr = JSON.stringify(lastSaveData, null, 2);
        var blob = new Blob([jsonStr], { type: 'application/json' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'projects.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        var sizeKB = (blob.size / 1024).toFixed(1);
        var cnt = Object.keys(lastSaveData).length;
        var msgHtml = '<div class="msg msg-success">âœ… projects.json ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (' + cnt + 'ê°œ í”„ë¡œì íŠ¸, ' + sizeKB + ' KB)</div>'
            + '<div class="msg msg-warn" style="margin-top:8px;">ğŸ“Œ ë‹¤ìš´ë¡œë“œí•œ íŒŒì¼ì„ GitHub ë ˆí¬ì˜ <strong>data/</strong> í´ë”ì— ë„£ê³  push í•´ì£¼ì„¸ìš”.</div>';
        if (result.warnings.length > 0) {
            msgHtml += '<div class="msg msg-error" style="margin-top:8px;">' + result.warnings.join('<br>') + '</div>';
        }
        document.getElementById('save-msg').innerHTML = msgHtml;
    });

    // â”€â”€ ì„ë² ë“œ URL ìƒì„± â”€â”€
    document.getElementById('generateUrlBtn').addEventListener('click', function() {
        var baseUrl = getBaseUrl();
        if (!baseUrl) {
            alert('GitHub ê³„ì •ëª…ê³¼ ë ˆí¬ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
        }

        var result = collectSelectedData();
        var data   = result.data;
        var names  = Object.keys(data);

        var urlHTML = '<h3 style="margin-top:20px; margin-bottom:12px;">ğŸ“‹ ë…¸ì…˜ ì„ë² ë“œìš© URL (' + names.length + 'ê°œ)</h3>';
        names.forEach(function(name) {
            var enc = encodeURIComponent(name);
            var tableUrl = baseUrl + '/view.html?project=' + enc + '&type=table';
            var chartUrl = baseUrl + '/view.html?project=' + enc + '&type=chart';

            var costUrl    = baseUrl + '/view.html?project=' + enc + '&type=cost';
            var barUrl     = baseUrl + '/view.html?project=' + enc + '&type=bar';
            var pieUrl     = baseUrl + '/view.html?project=' + enc + '&type=pie';
            var pieUrlPrev = baseUrl + '/view.html?project=' + enc + '&type=pie&month=prev';
            urlHTML += '<div class="url-group"><h4>ğŸ“Œ ' + name + '</h4>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:40px;">í‘œ</span><code>' + tableUrl + '</code><button class="copy-btn" data-url="' + tableUrl + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:40px;">MM</span><code>' + chartUrl + '</code><button class="copy-btn" data-url="' + chartUrl + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:40px;">ë¹„ìš©</span><code>' + costUrl + '</code><button class="copy-btn" data-url="' + costUrl + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:40px;">ë§‰ëŒ€</span><code>' + barUrl + '</code><button class="copy-btn" data-url="' + barUrl + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:55px;">íŒŒì´(ê¸°ì¤€)</span><code>' + pieUrl + '</code><button class="copy-btn" data-url="' + pieUrl + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:55px;">íŒŒì´(ì „ë‹¬)</span><code>' + pieUrlPrev + '</code><button class="copy-btn" data-url="' + pieUrlPrev + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><span style="font-size:12px;color:#888;width:55px;">ëŒ€ì‹œë³´ë“œ</span><code>' + (baseUrl + '/view.html?project=' + enc + '&type=dashboard') + '</code><button class="copy-btn" data-url="' + (baseUrl + '/view.html?project=' + enc + '&type=dashboard') + '">ë³µì‚¬</button></div></div>';
        });

        document.getElementById('url-output').innerHTML = urlHTML;

        document.querySelectorAll('.copy-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var self = this;
                navigator.clipboard.writeText(self.getAttribute('data-url')).then(function() {
                    self.textContent = 'âœ“ ë³µì‚¬ë¨';
                    setTimeout(function() { self.textContent = 'ë³µì‚¬'; }, 1500);
                });
            });
        });
    });
});
</script>
</body>
</html>
