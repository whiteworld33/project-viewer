<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í”„ë¡œì íŠ¸ ë°ì´í„° ê´€ë¦¬ì</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #f4f4f9; color: #333; }
        h1 { text-align: center; margin-bottom: 8px; }
        .subtitle { text-align: center; color: #888; margin-bottom: 24px; font-size: 14px; }
        .container { background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); max-width: 1000px; margin: 0 auto; }
        .section { margin-bottom: 24px; }
        .section-title { font-size: 16px; font-weight: 600; margin-bottom: 10px; padding-bottom: 6px; border-bottom: 2px solid #eee; }
        .section-title .badge { font-size: 12px; background: #e0e0e0; color: #555; padding: 2px 8px; border-radius: 10px; margin-left: 8px; font-weight: 400; }

        /* íŒŒì¼ ì—…ë¡œë“œ */
        .file-area { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .file-area input[type="file"] { font-size: 14px; }
        .file-area .status { font-size: 13px; color: #888; }

        /* í”„ë¡œì íŠ¸ ëª©ë¡ */
        #project-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(440px, 1fr)); gap: 10px; }
        .project-card { display: flex; align-items: center; gap: 10px; padding: 10px 14px; border: 1px solid #e0e0e0; border-radius: 6px; background: #fafafa; }
        .project-card.selected { border-color: #007bff; background: #f0f7ff; }
        .project-card input[type="checkbox"] { width: 18px; height: 18px; flex-shrink: 0; }
        .project-card .name { font-weight: 500; min-width: 160px; font-size: 14px; }
        .project-card .dates { display: flex; gap: 6px; font-size: 12px; }
        .project-card .dates label { color: #666; }
        .project-card .dates input[type="month"] { font-size: 12px; padding: 2px 4px; border: 1px solid #ccc; border-radius: 3px; width: 120px; }

        /* ë²„íŠ¼ */
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
        .btn { font-size: 15px; padding: 10px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 500; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: #fff; }
        .btn-secondary:hover { background: #545b62; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-danger:hover { background: #b02a37; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* URL ê²°ê³¼ */
        #url-output { margin-top: 20px; }
        .url-group { margin-bottom: 16px; }
        .url-group h4 { margin-bottom: 6px; color: #333; }
        .url-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .url-row code { flex: 1; background: #f5f5f5; padding: 8px 12px; border-radius: 4px; font-size: 13px; word-break: break-all; border: 1px solid #e0e0e0; }
        .url-row .copy-btn { font-size: 12px; padding: 6px 12px; background: #28a745; color: #fff; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap; }
        .url-row .copy-btn:hover { background: #218838; }

        /* ìƒíƒœ ë©”ì‹œì§€ */
        .msg { padding: 10px 16px; border-radius: 6px; margin-top: 12px; font-size: 14px; }
        .msg-success { background: #d4edda; color: #155724; }
        .msg-error { background: #f8d7da; color: #721c24; }
        .msg-info { background: #d1ecf1; color: #0c5460; }

        /* ì €ì¥ í˜„í™© */
        #storage-info { font-size: 13px; color: #888; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š í”„ë¡œì íŠ¸ ë°ì´í„° ê´€ë¦¬ì</h1>
    <p class="subtitle">ì—‘ì…€ â†’ localStorage â†’ view.html ì„ë² ë“œ</p>

    <!-- STEP 1: íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="section">
        <div class="section-title">1ï¸âƒ£ ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</div>
        <div class="file-area">
            <input type="file" id="fileInput" accept=".xlsx,.xls">
            <span class="status" id="file-status">íŒŒì¼ì„ ì„ íƒí•´ ì£¼ì„¸ìš”</span>
        </div>
    </div>

    <!-- STEP 2: í”„ë¡œì íŠ¸ ì„ íƒ -->
    <div class="section">
        <div class="section-title">2ï¸âƒ£ í”„ë¡œì íŠ¸ ì„ íƒ ë° ê¸°ê°„ ì„¤ì • <span class="badge" id="project-count">0ê°œ íƒì§€</span></div>
        <div id="project-list">
            <p style="color:#aaa; font-size:14px;">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ í”„ë¡œì íŠ¸ ëª©ë¡ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
        <div class="btn-group" style="justify-content:flex-start; margin-top:10px;">
            <button class="btn btn-secondary" id="selectAllBtn" style="font-size:13px; padding:6px 14px;" disabled>ì „ì²´ ì„ íƒ</button>
            <button class="btn btn-secondary" id="deselectAllBtn" style="font-size:13px; padding:6px 14px;" disabled>ì „ì²´ í•´ì œ</button>
        </div>
    </div>

    <!-- STEP 3: ì €ì¥ -->
    <div class="section">
        <div class="section-title">3ï¸âƒ£ ë°ì´í„° ì €ì¥ ë° URL ìƒì„±</div>
        <div class="btn-group">
            <button class="btn btn-primary" id="saveBtn" disabled>ğŸ’¾ ì„ íƒí•œ í”„ë¡œì íŠ¸ ë°ì´í„° ì €ì¥</button>
            <button class="btn btn-danger" id="clearBtn">ğŸ—‘ï¸ ì €ì¥ ë°ì´í„° ì´ˆê¸°í™”</button>
        </div>
        <div id="save-msg"></div>
        <div id="storage-info"></div>
        <div id="url-output"></div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // â”€â”€ ì—‘ì…€ ë‚ ì§œ ë³€í™˜ â”€â”€
    function excelDateToYM(serial) {
        if (typeof serial !== 'number') return null;
        if (serial > 59) serial -= 1;
        const d = new Date((serial - 25568) * 86400 * 1000);
        const y = d.getFullYear();
        const m = ('0' + (d.getMonth() + 1)).slice(-2);
        return y + '-' + m;
    }

    let parsedProjects = {}; // { projectName: { rows: [...], rowIndex, colIndex } }

    // â”€â”€ STEP 1: íŒŒì¼ ì—…ë¡œë“œ ì‹œ ìë™ íŒŒì‹± â”€â”€
    document.getElementById('fileInput').addEventListener('change', function() {
        const file = this.files[0];
        if (!file) return;
        document.getElementById('file-status').textContent = 'íŒŒì‹± ì¤‘...';

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = 'ê°œë°œì „ëµê¸°íšì‹¤';
                const ws = workbook.Sheets[sheetName];
                if (!ws) throw new Error("'" + sheetName + "' ì‹œíŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                const sheet = XLSX.utils.sheet_to_json(ws, { header: 1, defval: null });
                parsedProjects = {};

                // í”„ë¡œì íŠ¸ íƒì§€: í”„ë¡œì íŠ¸ëª… ì…€ â†’ +5í–‰ë¶€í„° ë‚ ì§œ(ìˆ«ì)ê°€ ì‹œì‘ë˜ëŠ” ì…€
                for (let i = 0; i < sheet.length; i++) {
                    for (let j = 0; j < (sheet[i] || []).length; j++) {
                        const cellVal = (sheet[i][j] || '').toString().trim();
                        if (!cellVal || typeof sheet[i][j] === 'number') continue;

                        // +5í–‰ ì•„ë˜ ì²« ì…€ì´ ìˆ«ì(ì—‘ì…€ ë‚ ì§œ)ì¸ì§€ í™•ì¸
                        const dataRow = i + 5;
                        if (dataRow >= sheet.length) continue;
                        const checkVal = (sheet[dataRow] || [])[j];
                        if (typeof checkVal !== 'number' || checkVal < 30000 || checkVal > 60000) continue;

                        // ìœ íš¨ í”„ë¡œì íŠ¸ë¡œ íŒì •
                        const rows = [];
                        for (let r = dataRow; r < sheet.length; r++) {
                            const rv = (sheet[r] || [])[j];
                            if (rv === null || typeof rv !== 'number') break;
                            const ym = excelDateToYM(rv);
                            if (!ym) break;
                            const row = sheet[r] || [];
                            rows.push({
                                date: ym,
                                mmDev: row[j + 1] || 0,
                                mmBiz: row[j + 2] || 0,
                                mmTotal: row[j + 3] || 0,
                                costDev: row[j + 4] || 0,
                                costBiz: row[j + 5] || 0,
                                costTotal: row[j + 6] || 0,
                                costGI: row[j + 7] || 0
                            });
                        }
                        if (rows.length > 0) {
                            parsedProjects[cellVal] = {
                                rows: rows,
                                firstDate: rows[0].date,
                                lastDate: rows[rows.length - 1].date
                            };
                        }
                    }
                }

                const names = Object.keys(parsedProjects);
                document.getElementById('file-status').textContent = file.name + ' (' + names.length + 'ê°œ í”„ë¡œì íŠ¸ íƒì§€)';
                document.getElementById('project-count').textContent = names.length + 'ê°œ íƒì§€';
                renderProjectList(names);

            } catch(err) {
                document.getElementById('file-status').textContent = 'ì˜¤ë¥˜: ' + err.message;
                document.getElementById('project-list').innerHTML = '<p style="color:red;">' + err.message + '</p>';
            }
        };
        reader.readAsArrayBuffer(file);
    });

    // â”€â”€ í”„ë¡œì íŠ¸ ëª©ë¡ ë Œë”ë§ â”€â”€
    function renderProjectList(names) {
        const container = document.getElementById('project-list');
        if (names.length === 0) {
            container.innerHTML = '<p style="color:#aaa;">íƒì§€ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const now = new Date();
        const currentYM = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2);

        container.innerHTML = names.map(function(name) {
            const p = parsedProjects[name];
            return '<div class="project-card" data-name="' + name + '">'
                + '<input type="checkbox" class="proj-check">'
                + '<span class="name">' + name + '</span>'
                + '<div class="dates">'
                + '<div><label>í‚¥ì˜¤í”„</label><input type="month" class="dt-kickoff" value="' + p.firstDate + '"></div>'
                + '<div><label>ê¸°ì¤€ì›”</label><input type="month" class="dt-current" value="' + currentYM + '"></div>'
                + '<div><label>ëŸ°ì¹­</label><input type="month" class="dt-launch" value="' + p.lastDate + '"></div>'
                + '</div></div>';
        }).join('');

        // ì¹´ë“œ í´ë¦­ ì‹œ ì²´í¬ë°•ìŠ¤ í† ê¸€
        container.querySelectorAll('.project-card').forEach(function(card) {
            card.addEventListener('click', function(e) {
                if (e.target.tagName === 'INPUT') return;
                const cb = card.querySelector('.proj-check');
                cb.checked = !cb.checked;
                card.classList.toggle('selected', cb.checked);
                updateSaveBtn();
            });
            card.querySelector('.proj-check').addEventListener('change', function() {
                card.classList.toggle('selected', this.checked);
                updateSaveBtn();
            });
        });

        document.getElementById('selectAllBtn').disabled = false;
        document.getElementById('deselectAllBtn').disabled = false;
        updateSaveBtn();
    }

    function updateSaveBtn() {
        const checked = document.querySelectorAll('.proj-check:checked').length;
        document.getElementById('saveBtn').disabled = (checked === 0);
    }

    // ì „ì²´ ì„ íƒ/í•´ì œ
    document.getElementById('selectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.proj-check').forEach(function(cb) { cb.checked = true; cb.closest('.project-card').classList.add('selected'); });
        updateSaveBtn();
    });
    document.getElementById('deselectAllBtn').addEventListener('click', function() {
        document.querySelectorAll('.proj-check').forEach(function(cb) { cb.checked = false; cb.closest('.project-card').classList.remove('selected'); });
        updateSaveBtn();
    });

    // â”€â”€ STEP 3: ì €ì¥ â”€â”€
    document.getElementById('saveBtn').addEventListener('click', function() {
        const cards = document.querySelectorAll('.project-card');
        const saveData = {};
        const urlLines = [];

        cards.forEach(function(card) {
            const cb = card.querySelector('.proj-check');
            if (!cb.checked) return;
            const name = card.getAttribute('data-name');
            const kickoff = card.querySelector('.dt-kickoff').value;
            const current = card.querySelector('.dt-current').value;
            const launch = card.querySelector('.dt-launch').value;
            const proj = parsedProjects[name];
            if (!proj) return;

            // ê¸°ê°„ í•„í„°ë§
            const filtered = proj.rows.filter(function(r) {
                return r.date >= kickoff && r.date <= launch;
            });

            saveData[name] = {
                kickoff: kickoff,
                current: current,
                launch: launch,
                rows: filtered
            };

            // URL ìƒì„±
            const base = 'view.html';
            const encName = encodeURIComponent(name);
            urlLines.push({
                name: name,
                tableUrl: base + '?project=' + encName + '&type=table',
                chartUrl: base + '?project=' + encName + '&type=chart'
            });
        });

        localStorage.setItem('projectViewerData', JSON.stringify(saveData));

        // ì €ì¥ í¬ê¸° í‘œì‹œ
        const size = new Blob([JSON.stringify(saveData)]).size;
        const sizeKB = (size / 1024).toFixed(1);
        document.getElementById('storage-info').textContent = 'ì €ì¥ ìš©ëŸ‰: ' + sizeKB + ' KB / í”„ë¡œì íŠ¸ ' + Object.keys(saveData).length + 'ê°œ';

        // ì„±ê³µ ë©”ì‹œì§€
        document.getElementById('save-msg').innerHTML = '<div class="msg msg-success">âœ… ' + Object.keys(saveData).length + 'ê°œ í”„ë¡œì íŠ¸ ë°ì´í„°ê°€ localStorageì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';

        // URL ì¶œë ¥
        var urlHTML = '<h3 style="margin-top:20px; margin-bottom:12px;">ğŸ“‹ ìƒì„±ëœ View URL</h3>';
        urlLines.forEach(function(u) {
            urlHTML += '<div class="url-group"><h4>ğŸ“Œ ' + u.name + '</h4>'
                + '<div class="url-row"><code>' + u.tableUrl + '</code><button class="copy-btn" data-url="' + u.tableUrl + '">ë³µì‚¬</button></div>'
                + '<div class="url-row"><code>' + u.chartUrl + '</code><button class="copy-btn" data-url="' + u.chartUrl + '">ë³µì‚¬</button></div></div>';
        });
        document.getElementById('url-output').innerHTML = urlHTML;

        // ë³µì‚¬ ë²„íŠ¼
        document.querySelectorAll('.copy-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                navigator.clipboard.writeText(this.getAttribute('data-url')).then(function() {
                    btn.textContent = 'âœ“ ë³µì‚¬ë¨';
                    setTimeout(function() { btn.textContent = 'ë³µì‚¬'; }, 1500);
                });
            });
        });
    });

    // â”€â”€ ë°ì´í„° ì´ˆê¸°í™” â”€â”€
    document.getElementById('clearBtn').addEventListener('click', function() {
        if (!confirm('ì €ì¥ëœ ëª¨ë“  í”„ë¡œì íŠ¸ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        localStorage.removeItem('projectViewerData');
        document.getElementById('save-msg').innerHTML = '<div class="msg msg-info">ğŸ—‘ï¸ ì €ì¥ ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
        document.getElementById('url-output').innerHTML = '';
        document.getElementById('storage-info').textContent = '';
    });

    // â”€â”€ í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì €ì¥ ë°ì´í„° í‘œì‹œ â”€â”€
    var existing = localStorage.getItem('projectViewerData');
    if (existing) {
        try {
            var parsed = JSON.parse(existing);
            var cnt = Object.keys(parsed).length;
            var size = new Blob([existing]).size;
            document.getElementById('storage-info').textContent = 'í˜„ì¬ ì €ì¥: ' + cnt + 'ê°œ í”„ë¡œì íŠ¸ (' + (size/1024).toFixed(1) + ' KB)';
        } catch(e) {}
    }
});
</script>
</body>
</html>